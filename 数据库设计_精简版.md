# 3.3 数据库设计

## 3.3.1 概念结构设计

数据库是系统开发的重要环节。本系统采用精简设计理念，从需求分析阶段的用例分析中可以得到用户、管理员、图书、分类、借阅、评论、社区帖子、通知、登录日志、操作日志十个核心实体。下面给出对应实体属性图。

### 1. 用户实体

用户实体是图书借阅推荐系统的核心实体之一，包括用户编号、用户名、密码、昵称、头像、邮箱、手机号、账号状态、用户令牌、创建时间十个属性。用户是系统的主要使用者，可以浏览图书、借阅图书、发表评论和参与社区互动。用户账号状态包括正常和封号两种状态，方便管理员对违规用户进行管理。用户令牌用于用户身份验证和保持登录状态。

用户实体属性图如图3-1所示。

### 2. 管理员实体

管理员实体负责系统管理和内容审核，包括管理员编号、管理员账号、密码、管理员姓名、管理员令牌、创建时间六个属性。管理员拥有系统最高权限，可以管理图书信息、用户信息、审核评论、查看日志、发布通知等。管理员令牌用于后台管理系统的身份验证，与普通用户的令牌相互独立，确保系统安全性。实际实现中，管理员可以通过用户表的角色字段区分，也可以独立存储。

管理员实体属性图如图3-2所示。

### 3. 图书实体

图书实体是系统的核心资源实体，包括图书编号、分类编号、图书标题、作者、出版社、ISBN编号、图书封面、图书简介、库存数量、图书状态、浏览量、评分、创建时间十三个属性。图书状态包括上架和下架两种状态，便于管理员控制图书的展示。库存数量记录当前可借阅的图书数量，当库存为0时用户无法借阅。浏览量和评分等统计数据用于推荐算法的计算。

图书实体属性图如图3-3所示。

### 4. 分类实体

分类实体用于组织图书的分类体系，包括分类编号、父分类编号、分类名称、创建时间四个属性。分类采用树形结构设计，通过父分类编号字段实现分类的层级关系。系统支持多级分类，顶级分类的父编号为-1。分类体系包括小说、文学、经济学、计算机、历史等多个大类，每个大类下可以继续细分子类别，形成完整的图书分类体系。

分类实体属性图如图3-4所示。

### 5. 借阅实体

借阅实体记录用户借阅图书的完整过程，包括借阅编号、用户编号、图书编号、借阅状态、借阅时间、应还时间、实际归还时间、是否延期八个属性。借阅状态分为借出和已还两种，方便统计图书的流转情况。系统记录应还时间和实际归还时间，可以计算逾期天数并提醒用户及时归还。延期标志用于标记需要延长借阅期限的记录。借阅记录是推荐算法的重要数据来源。

借阅实体属性图如图3-5所示。

### 6. 评论实体

评论实体记录用户对图书的评价信息，包括评论编号、评论内容、用户编号、图书编号、评论时间、点赞数六个属性。用户在阅读图书后可以发表自己的看法和感受，帮助其他用户了解图书质量和内容特点。评论支持点赞功能，优质评论可以获得更多关注。评论时间按照发布时间倒序排列，方便用户查看最新评价。系统管理员可以对不当评论进行审核和删除。

评论实体属性图如图3-6所示。

### 7. 社区帖子实体

社区帖子实体支持用户在平台上进行交流互动，包括帖子编号、帖子标题、帖子内容、发布用户编号、发布时间、浏览量、点赞数七个属性。用户可以发表读书心得、推荐好书、讨论书评等内容，形成活跃的阅读社区。帖子支持点赞功能，通过点赞数可以筛选优质内容。浏览量统计可以了解帖子的受欢迎程度。系统通过社区帖子增强用户粘性。

社区帖子实体属性图如图3-7所示。

### 8. 通知实体

通知实体用于发布系统通知和重要信息，包括通知编号、通知标题、通知内容、创建时间四个属性。管理员可以发布图书推荐、活动通知、系统维护等各类公告。通知在首页显著位置展示，确保用户及时获取重要信息。通知内容支持富文本格式，可以插入图片和链接，提供更丰富的信息展示。

通知实体属性图如图3-8所示。

### 9. 登录日志实体

登录日志实体用于记录用户和管理员的登录信息，包括日志编号、用户名、IP地址、用户代理、登录时间五个属性。登录日志记录所有登录行为，用于安全审计、异常登录检测、用户行为分析等。管理员可以查看用户的登录历史，发现异常登录（如异地登录）时及时采取安全措施。

登录日志实体属性图如图3-9所示。

### 10. 操作日志实体

操作日志实体用于记录系统的关键操作，包括日志编号、请求IP、请求时间、请求URL、请求方法、请求内容、访问耗时七个属性。操作日志记录系统的所有HTTP请求，主要用于系统监控、性能分析、问题排查。访问耗时用于性能优化，发现慢接口并进行针对性优化。日志数据量较大，建议定期清理或归档。

操作日志实体属性图如图3-10所示。

### 实体关系描述

上面给出了图书借阅推荐系统的各个核心实体，下面将分析实体与实体之间的关系，内容如下：

1. **用户与图书构成多对多关系**：用户可以借阅多本图书，一本图书可以被多个用户借阅。通过借阅实体关联用户和图书。

2. **用户与借阅呈一对多关系**：一个用户可以有多条借阅记录，每条借阅记录仅属于一个用户。

3. **图书与借阅呈一对多关系**：一本图书可以有多条借阅记录，每条借阅记录仅关联一本图书。

4. **用户与评论呈一对多关系**：一个用户可以发表多条评论，每条评论仅属于一个用户。

5. **图书与评论呈一对多关系**：一本图书可以有多条评论，每条评论仅针对一本图书。

6. **图书与分类呈多对一关系**：一本图书属于一个分类，一个分类下可以有多本图书。

7. **分类与分类呈一对多关系（自引用）**：一个分类可以有多个子分类，一个分类只能有一个父分类，形成树形结构（顶级分类pid=-1）。

8. **用户与社区帖子呈一对多关系**：一个用户可以发布多个帖子，每个帖子仅属于一个用户。

9. **管理员与通知呈逻辑关系**：管理员可以发布多条通知，通知不存储发布者信息（简化设计）。

10. **用户/管理员与登录日志呈一对多关系**：一个用户/管理员可以有多条登录日志，每条日志对应一次登录行为。

11. **系统与操作日志呈独立关系**：操作日志记录所有HTTP请求，不直接关联用户或管理员。

针对上述实体之间的关系，系统E-R图展示了各实体的完整关联结构，如图3-11所示。

## 3.3.2 逻辑结构设计

经过上面的分析与设计已经得出了初步的E-R图，接下来将根据E-R图设计逻辑结构，内容如下，其中属性有<u>**双下划线**</u>的为主键，<u>单下划线</u>的为外键。

1. **用户**（<u>**用户编号**</u>，用户名，密码，昵称，头像，手机号，邮箱，账号状态，用户令牌，创建时间）

2. **图书**（<u>**图书编号**</u>，图书标题，作者，<u>分类编号</u>，封面图片，图书简介，库存数量，浏览量，愿望单数，收藏数，图书状态，出版时间）

3. **分类**（<u>**分类编号**</u>，父分类编号，分类名称）

4. **借阅**（<u>**借阅编号**</u>，<u>用户编号</u>，<u>图书编号</u>，借阅状态，借阅时间，应还时间）

5. **评论**（<u>**评论编号**</u>，<u>用户编号</u>，<u>图书编号</u>，评论内容，评论时间，点赞数）

6. **管理员**（<u>**管理员编号**</u>，管理员名称，管理员密码）

7. **社区帖子**（<u>**帖子编号**</u>，<u>用户编号</u>，帖子标题，帖子内容，发布时间，浏览量，点赞数）

8. **通知**（<u>**通知编号**</u>，通知标题，通知内容，创建时间）

9. **登录日志**（<u>**日志编号**</u>，用户名，IP地址，用户代理，登录时间）

10. **操作日志**（<u>**日志编号**</u>，请求IP，请求时间，请求URL，请求方法，访问耗时）

## 3.3.3 表结构设计

根据上一阶段得出的优化之后的关系模式，系统一共设计出十张对应的数据表，下面将给出所有数据表的信息，如表3-1所示。

**表3-1 数据表概述**

| 表名 | 说明 | 功能 |
|------|------|------|
| b_user | 用户表 | 存储用户基本信息和认证信息 |
| b_admin | 管理员表 | 存储管理员基本信息 |
| b_book | 图书表 | 存储图书详细信息 |
| b_classification | 分类表 | 存储图书分类信息 |
| b_borrow | 借阅表 | 记录图书借阅信息 |
| b_comment | 评论表 | 存储用户对图书的评论 |
| b_community_post | 社区帖子表 | 存储用户发布的社区帖子 |
| b_notice | 通知表 | 存储系统公告信息 |
| b_login_log | 登录日志表 | 记录用户和管理员登录日志 |
| b_op_log | 操作日志表 | 存储系统操作日志 |

数据表结构具体内容如下：

### 1. 用户表

图书借阅推荐系统的用户表名称为b_user，主要记录用户的基本信息和认证信息，数据表逻辑结构如表3-2所示。

**表3-2 用户表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 用户编号 | bigint | | 主键 | 否 | 自增 |
| username | 用户名 | varchar | 50 | | 是 | |
| password | 密码 | varchar | 50 | | 是 | |
| nickname | 昵称 | varchar | 20 | | 是 | |
| avatar | 头像 | varchar | 100 | | 是 | |
| mobile | 手机号 | varchar | 13 | | 是 | |
| email | 邮箱 | varchar | 50 | | 是 | |
| status | 账号状态 | varchar | 1 | | 是 | '0' |
| token | 用户令牌 | varchar | 32 | | 是 | |
| create_time | 创建时间 | datetime | 6 | | 是 | |

### 2. 管理员表

管理员表名称为b_admin，主要记录管理员的基本信息，数据表逻辑结构如表3-3所示。

**表3-3 管理员表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 管理员编号 | bigint | | 主键 | 否 | 自增 |
| name | 管理员名称 | varchar | 50 | | 是 | |
| password | 管理员密码 | varchar | 50 | | 是 | |

### 3. 图书表

图书表名称为b_book，主要记录图书的详细信息，数据表逻辑结构如表3-4所示。

**表3-4 图书表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 图书编号 | bigint | | 主键 | 否 | 自增 |
| title | 图书标题 | varchar | 255 | | 是 | |
| author | 作者 | varchar | 50 | | 是 | |
| classification_id | 分类编号 | bigint | | 外键 | 是 | |
| cover | 封面图片 | varchar | 100 | | 是 | |
| description | 图书简介 | longtext | | | 是 | |
| repertory | 库存数量 | int | | | 否 | 0 |
| pv | 浏览量 | int | | | 否 | 0 |
| wish_count | 愿望单数 | int | | | 否 | 0 |
| collect_count | 收藏数 | int | | | 否 | 0 |
| status | 图书状态 | varchar | 1 | | 否 | '0' |
| pub_time | 出版时间 | date | | | 是 | |

### 4. 分类表

分类表名称为b_classification，采用树形结构设计，数据表逻辑结构如表3-5所示。

**表3-5 分类表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 分类编号 | bigint | | 主键 | 否 | 自增 |
| pid | 父分类编号 | int | | | 是 | -1 |
| title | 分类名称 | varchar | 100 | | 是 | |

### 5. 借阅表

借阅表名称为b_borrow，主要记录用户借阅图书的信息，数据表逻辑结构如表3-6所示。

**表3-6 借阅表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 借阅编号 | bigint | | 主键 | 否 | 自增 |
| user_id | 用户编号 | bigint | | 外键 | 是 | |
| book_id | 图书编号 | bigint | | 外键 | 是 | |
| status | 借阅状态 | varchar | 2 | | 是 | |
| borrow_time | 借阅时间 | datetime | 6 | | 是 | |
| expect_time | 应还时间 | datetime | 6 | | 是 | |

### 6. 评论表

评论表名称为b_comment，主要记录用户对图书的评论，数据表逻辑结构如表3-7所示。

**表3-7 评论表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 评论编号 | bigint | | 主键 | 否 | 自增 |
| user_id | 用户编号 | bigint | | 外键 | 是 | |
| book_id | 图书编号 | bigint | | 外键 | 是 | |
| content | 评论内容 | varchar | 200 | | 是 | |
| comment_time | 评论时间 | datetime | 6 | | 是 | |
| like_count | 点赞数 | int | | | 否 | 0 |

### 7. 社区帖子表

社区帖子表名称为b_community_post，主要记录用户发布的社区帖子，数据表逻辑结构如表3-8所示。

**表3-8 社区帖子表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 帖子编号 | bigint | | 主键 | 否 | 自增 |
| user_id | 用户编号 | bigint | | 外键 | 是 | |
| title | 帖子标题 | varchar | 100 | | 是 | |
| content | 帖子内容 | longtext | | | 是 | |
| create_time | 发布时间 | datetime | 6 | | 是 | |
| views | 浏览量 | int | | | 否 | 0 |
| like_count | 点赞数 | int | | | 否 | 0 |

### 8. 通知表

通知表名称为b_notice，主要记录系统公告信息，数据表逻辑结构如表3-9所示。

**表3-9 通知表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 通知编号 | bigint | | 主键 | 否 | 自增 |
| title | 通知标题 | varchar | 100 | | 是 | |
| content | 通知内容 | varchar | 1000 | | 是 | |
| create_time | 创建时间 | datetime | 6 | | 是 | |

### 9. 登录日志表

登录日志表名称为b_login_log，主要记录用户和管理员的登录信息，数据表逻辑结构如表3-10所示。

**表3-10 登录日志表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 日志编号 | bigint | | 主键 | 否 | 自增 |
| username | 用户名 | varchar | 50 | | 是 | |
| ip | IP地址 | varchar | 100 | | 是 | |
| ua | 用户代理 | varchar | 200 | | 是 | |
| log_time | 登录时间 | datetime | 6 | | 是 | |

### 10. 操作日志表

操作日志表名称为b_op_log，主要记录系统操作日志，数据表逻辑结构如表3-11所示。

**表3-11 操作日志表**

| 字段名 | 字段说明 | 数据类型 | 长度 | 主键或外键 | 允许空值 | 默认值 |
|--------|---------|---------|------|-----------|---------|--------|
| id | 日志编号 | bigint | | 主键 | 否 | 自增 |
| re_ip | 请求IP | varchar | 100 | | 是 | |
| re_time | 请求时间 | datetime | 6 | | 是 | |
| re_url | 请求URL | varchar | 200 | | 是 | |
| re_method | 请求方法 | varchar | 10 | | 是 | |
| access_time | 访问耗时 | varchar | 10 | | 是 | |
