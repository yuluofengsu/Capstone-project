# 图书借阅推荐系统类图

本文档包含系统所有功能模块的PlantUML类图代码。

## 1. 数据模型类图（Django ORM Models）

### 1.1 用户与认证相关模型

```plantuml
@startuml 用户与认证模型
skinparam classAttributeIconSize 0

class User {
  + id: BigAutoField
  + username: CharField(50)
  + password: CharField(50)
  + role: CharField(2)
  + status: CharField(1)
  + nickname: CharField(20)
  + avatar: FileField
  + mobile: CharField(13)
  + email: CharField(50)
  + gender: CharField(1)
  + description: TextField(200)
  + create_time: DateTimeField
  + score: IntegerField
  + push_email: CharField(40)
  + push_switch: BooleanField
  + admin_token: CharField(32)
  + token: CharField(32)
  --
  + GENDER_CHOICES
  + ROLE_CHOICES
  + STATUS_CHOICES
}

class LoginLog {
  + id: BigAutoField
  + username: CharField(50)
  + ip: CharField(100)
  + ua: CharField(200)
  + log_time: DateTimeField
}

class OpLog {
  + id: BigAutoField
  + re_ip: CharField(100)
  + re_time: DateTimeField
  + re_url: CharField(200)
  + re_method: CharField(10)
  + re_content: CharField(200)
  + access_time: CharField(10)
}

class ErrorLog {
  + id: BigAutoField
  + ip: CharField(100)
  + url: CharField(200)
  + method: CharField(10)
  + content: CharField(200)
  + log_time: DateTimeField
}

User "1" --> "0..*" LoginLog : 记录登录
User "1" --> "0..*" OpLog : 产生操作日志
@enduml
```

### 1.2 图书相关模型

```plantuml
@startuml 图书相关模型
skinparam classAttributeIconSize 0

class Book {
  + id: BigAutoField
  + title: CharField(255)
  + original_title: CharField(255)
  + cover: ImageField
  + author: CharField(50)
  + translator: CharField(50)
  + description: TextField(1000)
  + press: CharField(50)
  + page_count: IntegerField
  + price: CharField(50)
  + isbn: CharField(50)
  + pub_date: DateField
  + online_time: DateTimeField
  + status: CharField(1)
  + repertory: IntegerField
  + score: CharField(10)
  + layout: CharField(10)
  + create_time: DateTimeField
  + pv: IntegerField
  + recommend_count: IntegerField
  + wish_count: IntegerField
  + collect_count: IntegerField
  --
  + STATUS_CHOICES
}

class Classification {
  + id: BigAutoField
  + pid: IntegerField
  + title: CharField(100)
  + create_time: DateTimeField
  --
  + __str__(): str
}

class Tag {
  + id: BigAutoField
  + title: CharField(100)
  + create_time: DateTimeField
}

class Banner {
  + id: BigAutoField
  + image: ImageField
  + create_time: DateTimeField
}

class Ad {
  + id: BigAutoField
  + image: ImageField
  + link: CharField(500)
  + create_time: DateTimeField
}

Book "0..*" --> "1" Classification : 分类
Book "0..*" --> "0..*" Tag : 标签
Book "1" <-- "0..*" Banner : 轮播图关联
Classification "1" --> "0..*" Classification : 父子分类
@enduml
```

### 1.3 借阅相关模型

```plantuml
@startuml 借阅相关模型
skinparam classAttributeIconSize 0

class User {
  + id: BigAutoField
  + username: CharField(50)
  + score: IntegerField
}

class Book {
  + id: BigAutoField
  + title: CharField(255)
  + repertory: IntegerField
}

class Borrow {
  + id: BigAutoField
  + status: CharField(2)
  + borrow_time: DateTimeField
  + expect_time: DateTimeField
  + return_time: DateTimeField
  + delayed: BooleanField
  --
  + STATUS: 1=借出, 2=已还
}

class BorrowLog {
  + id: BigAutoField
  + action: CharField(2)
  + log_time: DateTimeField
}

class Address {
  + id: BigAutoField
  + name: CharField(100)
  + mobile: CharField(30)
  + desc: CharField(300)
  + default: BooleanField
  + create_time: DateTimeField
}

User "1" --> "0..*" Borrow : 借阅
Book "1" <-- "0..*" Borrow : 被借阅
User "1" --> "0..*" BorrowLog : 借阅日志
Book "1" <-- "0..*" BorrowLog : 图书日志
User "1" --> "0..*" Address : 收货地址
@enduml
```

### 1.4 评论与社区模型

```plantuml
@startuml 评论与社区模型
skinparam classAttributeIconSize 0

class User {
  + id: BigAutoField
  + username: CharField(50)
  + nickname: CharField(20)
  + avatar: FileField
}

class Book {
  + id: BigAutoField
  + title: CharField(255)
}

class Comment {
  + id: BigAutoField
  + content: CharField(200)
  + comment_time: DateTimeField
  + like_count: IntegerField
}

class CommunityPost {
  + id: BigAutoField
  + title: CharField(100)
  + content: TextField(2000)
  + create_time: DateTimeField
  + views: IntegerField
  + like_count: IntegerField
}

class ReadingEvent {
  + id: BigAutoField
  + title: CharField(100)
  + description: TextField(2000)
  + cover: ImageField
  + start_time: DateTimeField
  + end_time: DateTimeField
  + create_time: DateTimeField
  + status: CharField(1)
  --
  + STATUS_CHOICES
}

class CommunityComment {
  + id: BigAutoField
  + content: CharField(500)
  + create_time: DateTimeField
  + like_count: IntegerField
}

class Notice {
  + id: BigAutoField
  + title: CharField(100)
  + content: CharField(1000)
  + create_time: DateTimeField
}

User "1" --> "0..*" Comment : 评论图书
Book "1" <-- "0..*" Comment : 被评论
User "1" --> "0..*" CommunityPost : 发帖
CommunityPost "0..*" --> "0..*" User : 点赞用户
User "1" --> "0..*" CommunityComment : 发表评论
CommunityPost "1" <-- "0..*" CommunityComment : 帖子评论
ReadingEvent "1" <-- "0..*" CommunityComment : 活动评论
Book "0..*" --> "0..*" User : 心愿清单
Book "0..*" --> "0..*" User : 收藏
@enduml
```

### 1.5 浏览记录模型

```plantuml
@startuml 浏览记录模型
skinparam classAttributeIconSize 0

class User {
  + id: BigAutoField
  + username: CharField(50)
}

class Book {
  + id: BigAutoField
  + title: CharField(255)
}

class Classification {
  + id: BigAutoField
  + title: CharField(100)
}

class Record {
  + id: BigAutoField
  + title: CharField(100)
  + record_time: DateTimeField
}

User "1" --> "0..*" Record : 浏览记录
Book "1" <-- "0..*" Record : 被浏览
Classification "1" <-- "0..*" Record : 分类记录
@enduml
```

## 2. 序列化器类图（Django REST Framework Serializers）

```plantuml
@startuml 序列化器类图
skinparam classAttributeIconSize 0

abstract class ModelSerializer {
  + Meta
  --
  + to_representation()
  + validate()
}

class BookSerializer {
  + classification_title: ReadOnlyField
  --
  + Meta.model = Book
  + Meta.fields = '__all__'
  + to_representation(instance)
}

class DetailBookSerializer {
  + classification_title: ReadOnlyField
  --
  + Meta.model = Book
  + Meta.exclude = ('wish', 'collect')
  + to_representation(instance)
}

class UpdateBookSerializer {
  + classification_title: ReadOnlyField
  --
  + Meta.model = Book
  + Meta.exclude = ('wish', 'collect')
  + to_representation(instance)
}

class ListBookSerializer {
  + classification_title: ReadOnlyField
  --
  + Meta.model = Book
  + Meta.exclude = ('wish', 'collect', 'description')
  + to_representation(instance)
}

class UserSerializer {
  + create_time: DateTimeField
  --
  + Meta.model = User
  + Meta.fields = '__all__'
}

class CommentSerializer {
  + comment_time: DateTimeField
  + title: ReadOnlyField
  + username: ReadOnlyField
  --
  + Meta.model = Comment
}

class BorrowSerializer {
  + borrow_time: DateTimeField
  + expect_time: DateTimeField
  + return_time: DateTimeField
  + username: ReadOnlyField
  + title: ReadOnlyField
  + cover: FileField
  --
  + Meta.model = Borrow
  + to_representation(instance)
}

class ClassificationSerializer {
  --
  + Meta.model = Classification
  + Meta.fields = '__all__'
}

class TagSerializer {
  --
  + Meta.model = Tag
  + Meta.fields = '__all__'
}

class NoticeSerializer {
  + create_time: DateTimeField
  --
  + Meta.model = Notice
  + Meta.fields = '__all__'
}

class AddressSerializer {
  + create_time: DateTimeField
  --
  + Meta.model = Address
  + Meta.fields = '__all__'
}

class CommunityPostSerializer {
  + create_time: DateTimeField
  + username: ReadOnlyField
  + avatar: FileField
  + nickname: ReadOnlyField
  --
  + Meta.model = CommunityPost
  + Meta.fields = '__all__'
}

class ReadingEventSerializer {
  + start_time: DateTimeField
  + end_time: DateTimeField
  + create_time: DateTimeField
  --
  + Meta.model = ReadingEvent
  + Meta.fields = '__all__'
}

class CommunityCommentSerializer {
  + create_time: DateTimeField
  + username: ReadOnlyField
  + avatar: FileField
  + nickname: ReadOnlyField
  --
  + Meta.model = CommunityComment
  + Meta.fields = '__all__'
}

class BannerSerializer {
  + create_time: DateTimeField
  + title: ReadOnlyField
  --
  + Meta.model = Banner
  + Meta.fields = '__all__'
}

class AdSerializer {
  + create_time: DateTimeField
  --
  + Meta.model = Ad
  + Meta.fields = '__all__'
}

class LoginLogSerializer {
  + log_time: DateTimeField
  --
  + Meta.model = LoginLog
  + Meta.fields = '__all__'
}

class OpLogSerializer {
  + re_time: DateTimeField
  --
  + Meta.model = OpLog
  + Meta.fields = '__all__'
}

class ErrorLogSerializer {
  + log_time: DateTimeField
  --
  + Meta.model = ErrorLog
  + Meta.fields = '__all__'
}

class RecordSerializer {
  --
  + Meta.model = Record
  + Meta.fields = '__all__'
}

class BorrowLogSerializer {
  --
  + Meta.model = BorrowLog
  + Meta.fields = '__all__'
}

ModelSerializer <|-- BookSerializer
ModelSerializer <|-- DetailBookSerializer
ModelSerializer <|-- UpdateBookSerializer
ModelSerializer <|-- ListBookSerializer
ModelSerializer <|-- UserSerializer
ModelSerializer <|-- CommentSerializer
ModelSerializer <|-- BorrowSerializer
ModelSerializer <|-- ClassificationSerializer
ModelSerializer <|-- TagSerializer
ModelSerializer <|-- NoticeSerializer
ModelSerializer <|-- AddressSerializer
ModelSerializer <|-- CommunityPostSerializer
ModelSerializer <|-- ReadingEventSerializer
ModelSerializer <|-- CommunityCommentSerializer
ModelSerializer <|-- BannerSerializer
ModelSerializer <|-- AdSerializer
ModelSerializer <|-- LoginLogSerializer
ModelSerializer <|-- OpLogSerializer
ModelSerializer <|-- ErrorLogSerializer
ModelSerializer <|-- RecordSerializer
ModelSerializer <|-- BorrowLogSerializer
@enduml
```

## 3. 认证与权限类图

```plantuml
@startuml 认证与权限类图
skinparam classAttributeIconSize 0

abstract class BaseAuthentication {
  --
  + {abstract} authenticate(request)
}

class AdminTokenAuthtication {
  --
  + authenticate(request): tuple
}

class TokenAuthtication {
  --
  + authenticate(request): tuple
}

class PermissionChecker {
  --
  + {static} isDemoAdminUser(request): bool
}

note right of AdminTokenAuthtication
  验证HTTP_ADMINTOKEN
  返回(user, adminToken)
  失败抛出AUTH_FAIL_END
end note

note right of TokenAuthtication
  验证HTTP_TOKEN
  返回(user, token)
  失败抛出AUTH_FAIL_FRONT
end note

note right of PermissionChecker
  检查是否为演示账号
  演示账号role=3
end note

BaseAuthentication <|-- AdminTokenAuthtication
BaseAuthentication <|-- TokenAuthtication
@enduml
```

## 4. 中间件类图

```plantuml
@startuml 中间件类图
skinparam classAttributeIconSize 0

abstract class MiddlewareMixin {
  --
  + __init__(*args)
  + process_request(request)
  + process_response(request, response)
}

class OpLogs {
  - start_time: float
  - end_time: float
  - data: dict
  --
  + __init__(*args)
  + process_request(request)
  + process_response(request, response): Response
}

note right of OpLogs
  记录API操作日志
  - 请求IP
  - 请求URL
  - 请求方法
  - 访问耗时
  保存到OpLog表
end note

MiddlewareMixin <|-- OpLogs
OpLogs ..> OpLogSerializer : 使用
@enduml
```

## 5. 工具类图

```plantuml
@startuml 工具类图
skinparam classAttributeIconSize 0

class Utils <<utility>> {
  --
  + {static} md5value(key: str): str
  + {static} dict_fetchall(cursor): list
  + {static} get_ip(request): str
  + {static} get_ua(request): str
  + {static} getWeekDays(): list
  + {static} get_monday(): str
  + {static} log_error(request, content)
}

class APIResponse {
  - code: int
  - msg: str
  - data: any
  --
  + __init__(code, msg, data, status, headers, content_type, **kwargs)
}

class ImageProxyHelper <<utility>> {
  --
  + {static} rewrite_cover_url(url: str, request): str
}

note right of Utils
  提供通用工具函数
  - MD5加密
  - IP获取
  - 日期处理
  - 错误日志记录
end note

note right of APIResponse
  统一API响应格式
  {
    "code": 0,
    "msg": "成功",
    "data": {...}
  }
end note

note right of ImageProxyHelper
  豆瓣图片代理处理
  避免跨域问题
end note

APIResponse --|> Response
Utils ..> ErrorLogSerializer : 使用
@enduml
```

## 6. 推荐算法类图

```plantuml
@startuml 推荐算法类图
skinparam classAttributeIconSize 0

class RecommendEngine {
  --
  + {static} build_user_item_matrix(): tuple
  + {static} recommend_books_based_on_collaborative_filtering(user_id: int): list
}

class MatrixBuilder {
  --
  + {static} create_matrix(users: list, books: list): ndarray
  + {static} calculate_rating(user, book): float
}

class SimilarityCalculator {
  --
  + {static} cosine_similarity(matrix: ndarray): ndarray
  + {static} find_similar_users(user_index: int, similarity_matrix: ndarray, k: int): list
}

class BookRecommender {
  --
  + {static} get_recommended_books(user, similar_users: list, books: list): list
  + {static} filter_user_books(user, books: list): list
}

note right of RecommendEngine
  协同过滤推荐算法
  1. 构建用户-图书评分矩阵
  2. 计算用户相似度
  3. 推荐相似用户喜欢的书
end note

note right of MatrixBuilder
  评分规则:
  - 收藏书籍: 1.0分
  - 心愿书籍: 0.5分
  - 未接触: 0.0分
end note

RecommendEngine ..> MatrixBuilder : 使用
RecommendEngine ..> SimilarityCalculator : 使用
RecommendEngine ..> BookRecommender : 使用
RecommendEngine ..> Book : 查询
RecommendEngine ..> User : 查询
@enduml
```

## 7. 视图层类图（后端Views）

### 7.1 后台管理视图

```plantuml
@startuml 后台管理视图
skinparam classAttributeIconSize 0

package "admin.book" {
  class BookAdminView <<view>> {
    --
    + list_api(request): Response
    + detail(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.user" {
  class UserAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + updatePwd(request): Response
    + delete(request): Response
    + info(request): Response
    + admin_login(request): Response
  }
}

package "admin.borrow" {
  class BorrowAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + return_book(request): Response
    + delay(request): Response
    + delete(request): Response
  }
}

package "admin.comment" {
  class CommentAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.classification" {
  class ClassificationAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.tag" {
  class TagAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.overview" {
  class OverviewView <<view>> {
    --
    + count(request): Response
    + sysInfo(request): Response
  }
}

package "admin.loginLog" {
  class LoginLogAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.opLog" {
  class OpLogAdminView <<view>> {
    --
    + list_api(request): Response
  }
}

package "admin.errorLog" {
  class ErrorLogAdminView <<view>> {
    --
    + list_api(request): Response
  }
}

package "admin.banner" {
  class BannerAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.ad" {
  class AdAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.notice" {
  class NoticeAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "admin.event" {
  class EventAdminView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

note bottom of BookAdminView
  需要AdminTokenAuthtication认证
  需要检查isDemoAdminUser
end note
@enduml
```

### 7.2 前台用户视图

```plantuml
@startuml 前台用户视图
skinparam classAttributeIconSize 0

package "index.book" {
  class BookIndexView <<view>> {
    --
    + list_api(request): Response
    + detail(request): Response
    + increaseWishCount(request): Response
    + addWishUser(request): Response
    + removeWishUser(request): Response
    + getWishBookList(request): Response
    + addCollectUser(request): Response
    + removeCollectUser(request): Response
    + getCollectBookList(request): Response
    + increaseRecommendCount(request): Response
  }
}

package "index.user" {
  class UserIndexView <<view>> {
    --
    + login(request): Response
    + register(request): Response
    + info(request): Response
    + update(request): Response
    + updatePwd(request): Response
  }
}

package "index.borrow" {
  class BorrowIndexView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + return_book(request): Response
    + delay(request): Response
  }
}

package "index.comment" {
  class CommentIndexView <<view>> {
    --
    + list_api(request): Response
    + list_my_comment(request): Response
    + create(request): Response
    + delete(request): Response
    + like(request): Response
  }
}

package "index.classification" {
  class ClassificationIndexView <<view>> {
    --
    + list_api(request): Response
  }
}

package "index.tag" {
  class TagIndexView <<view>> {
    --
    + list_api(request): Response
  }
}

package "index.notice" {
  class NoticeIndexView <<view>> {
    --
    + list_api(request): Response
  }
}

package "index.address" {
  class AddressIndexView <<view>> {
    --
    + list_api(request): Response
    + create(request): Response
    + update(request): Response
    + delete(request): Response
  }
}

package "index.community" {
  class CommunityIndexView <<view>> {
    --
    + post_list(request): Response
    + post_detail(request): Response
    + create_post(request): Response
    + like_post(request): Response
    + add_comment(request): Response
    + event_list(request): Response
    + event_detail(request): Response
  }
}

note bottom of BookIndexView
  list_api支持推荐排序
  调用RecommendEngine
end note

note bottom of BorrowIndexView
  需要TokenAuthtication认证
  借书时检查库存
  还书时增加积分
end note
@enduml
```

## 8. 前端架构类图

### 8.1 前端Store类图（Vuex）

```plantuml
@startuml 前端Store类图
skinparam classAttributeIconSize 0

class Store {
  - state: Object
  - getters: Object
  - mutations: Object
  - actions: Object
  --
  + dispatch(action, payload)
  + commit(mutation, payload)
}

class UserModule {
  - state
    + token: String
    + username: String
    + userId: String
    + adminToken: String
    + adminUserName: String
  - getters
    + token()
    + username()
    + userId()
    + adminToken()
    + adminUserName()
  - mutations
    + SET_TOKEN(state, token)
    + SET_USERNAME(state, username)
    + SET_USERID(state, userId)
    + SET_ADMIN_TOKEN(state, adminToken)
    + SET_ADMIN_USERNAME(state, adminUserName)
  - actions
    + AdminLogin({commit}, {username, password})
    + AdminLogout({commit, state})
    + Login({commit}, {username, password})
    + Logout({commit, state})
}

class Constants {
  + BASE_URL: String
  + TOKEN: String
  + USERNAME: String
  + USERID: String
  + ADMIN_TOKEN: String
  + ADMIN_USERNAME: String
}

Store *-- UserModule
UserModule ..> Constants : 使用
@enduml
```

### 8.2 前端API层类图

```plantuml
@startuml 前端API层类图
skinparam classAttributeIconSize 0

class RequestInterceptor {
  - baseURL: String
  - timeout: Number
  --
  + request(config): config
  + response(response): response
  + errorHandler(error): Promise
}

package "api.admin" {
  class AdminBookAPI {
    --
    + list(params): Promise
    + detail(params): Promise
    + create(data): Promise
    + update(id, data): Promise
    + delete(ids): Promise
  }
  
  class AdminUserAPI {
    --
    + list(params): Promise
    + create(data): Promise
    + update(id, data): Promise
    + updatePwd(data): Promise
    + delete(ids): Promise
    + adminLogin(data): Promise
  }
  
  class AdminBorrowAPI {
    --
    + list(params): Promise
    + create(data): Promise
    + update(id, data): Promise
    + returnBook(id, data): Promise
    + delay(id): Promise
    + delete(ids): Promise
  }
}

package "api.index" {
  class IndexBookAPI {
    --
    + list(params): Promise
    + detail(id): Promise
    + addWishUser(data): Promise
    + removeWishUser(data): Promise
    + getWishBookList(userId): Promise
    + addCollectUser(data): Promise
    + removeCollectUser(data): Promise
    + getCollectBookList(userId): Promise
  }
  
  class IndexUserAPI {
    --
    + login(data): Promise
    + register(data): Promise
    + info(token): Promise
    + update(data): Promise
    + updatePwd(data): Promise
  }
  
  class IndexBorrowAPI {
    --
    + list(params): Promise
    + create(data): Promise
    + returnBook(id, data): Promise
    + delay(id): Promise
  }
  
  class IndexCommentAPI {
    --
    + list(params): Promise
    + listMyComments(userId): Promise
    + create(data): Promise
    + delete(id): Promise
    + like(id): Promise
  }
}

RequestInterceptor <.. AdminBookAPI : 使用
RequestInterceptor <.. AdminUserAPI : 使用
RequestInterceptor <.. AdminBorrowAPI : 使用
RequestInterceptor <.. IndexBookAPI : 使用
RequestInterceptor <.. IndexUserAPI : 使用
RequestInterceptor <.. IndexBorrowAPI : 使用
RequestInterceptor <.. IndexCommentAPI : 使用

note right of RequestInterceptor
  拦截器功能:
  1. 自动添加Token
  2. 统一错误处理
  3. 403自动登出
end note
@enduml
```

### 8.3 前端Router类图

```plantuml
@startuml 前端Router类图
skinparam classAttributeIconSize 0

class VueRouter {
  - mode: String
  - routes: Array
  --
  + push(location)
  + replace(location)
  + go(n)
}

class Route {
  + path: String
  + name: String
  + component: Component
  + children: Array
  + redirect: String
  + meta: Object
}

class IndexRoutes <<routes>> {
  + /index
  + /index/portal
  + /index/login
  + /index/register
  + /index/detail
  + /index/search
  + /index/user/*
}

class AdminRoutes <<routes>> {
  + /admin
  + /admin/book
  + /admin/user
  + /admin/borrow
  + /admin/comment
  + /admin/classification
  + /admin/tag
  + /admin/overview
  + /admin/logs
}

VueRouter *-- "0..*" Route
Route <|-- IndexRoutes
Route <|-- AdminRoutes

note right of IndexRoutes
  前台路由
  - 图书浏览
  - 用户中心
  - 借阅管理
  - 社区互动
end note

note right of AdminRoutes
  后台路由
  - 图书管理
  - 用户管理
  - 借阅管理
  - 系统监控
end note
@enduml
```

## 9. 整体系统架构类图

```plantuml
@startuml 整体系统架构
skinparam packageStyle rectangle

package "前端层 (Vue.js)" {
  [Views] as FrontViews
  [Components] as FrontComponents
  [Router] as FrontRouter
  [Vuex Store] as FrontStore
  [API Client] as FrontAPI
  [Utils] as FrontUtils
}

package "API网关层 (Django REST Framework)" {
  [URL Routing] as URLRouting
  [Middleware] as Middleware
  [Authentication] as Auth
  [Permission] as Perm
}

package "业务逻辑层 (Views)" {
  [Admin Views] as AdminViews
  [Index Views] as IndexViews
  [Recommend Engine] as RecommendEngine
}

package "数据访问层 (ORM)" {
  [Serializers] as Serializers
  [Models] as Models
}

package "数据库层" {
  database "MySQL" as DB
}

FrontViews --> FrontRouter
FrontViews --> FrontStore
FrontViews --> FrontComponents
FrontComponents --> FrontAPI
FrontStore --> FrontAPI
FrontAPI --> FrontUtils

FrontAPI --> URLRouting : HTTP/HTTPS
URLRouting --> Middleware
Middleware --> Auth
Auth --> Perm
Perm --> AdminViews
Perm --> IndexViews

AdminViews --> Serializers
IndexViews --> Serializers
IndexViews --> RecommendEngine
RecommendEngine --> Models

Serializers --> Models
Models --> DB

note right of Middleware
  - CORS处理
  - 操作日志记录
  - 异常处理
end note

note right of Auth
  - AdminTokenAuthtication
  - TokenAuthtication
end note

note right of RecommendEngine
  - 协同过滤算法
  - 用户相似度计算
  - 图书推荐
end note
@enduml
```

## 10. 核心业务流程类图

### 10.1 用户认证流程

```plantuml
@startuml 用户认证流程
skinparam classAttributeIconSize 0

class LoginController {
  --
  + login(username, password): Response
  + logout(): Response
}

class AuthenticationService {
  --
  + validateCredentials(username, password): bool
  + generateToken(user): String
  + saveToken(user, token): bool
}

class TokenManager {
  --
  + createToken(): String
  + validateToken(token): bool
  + revokeToken(token): bool
}

class UserRepository {
  --
  + findByUsername(username): User
  + findByToken(token): User
  + updateToken(user, token): bool
}

LoginController --> AuthenticationService
AuthenticationService --> TokenManager
AuthenticationService --> UserRepository
TokenManager --> UserRepository

note right of AuthenticationService
  1. 验证用户名密码
  2. 生成32位Token
  3. 保存到数据库
  4. 返回Token和用户信息
end note
@enduml
```

### 10.2 图书借阅流程

```plantuml
@startuml 图书借阅流程
skinparam classAttributeIconSize 0

class BorrowController {
  --
  + borrow(userId, bookId): Response
  + returnBook(borrowId): Response
  + delay(borrowId): Response
}

class BorrowService {
  --
  + checkInventory(bookId): bool
  + checkDuplicate(userId, bookId): bool
  + createBorrow(userId, bookId): Borrow
  + updateInventory(bookId, delta): bool
  + calculateExpectTime(days): DateTime
}

class InventoryManager {
  --
  + getStock(bookId): int
  + decreaseStock(bookId): bool
  + increaseStock(bookId): bool
}

class BorrowRepository {
  --
  + findByUserAndBook(userId, bookId): Borrow
  + save(borrow): Borrow
  + update(borrow): bool
}

class ScoreManager {
  --
  + addScore(userId, points): bool
}

BorrowController --> BorrowService
BorrowService --> InventoryManager
BorrowService --> BorrowRepository
BorrowService --> ScoreManager

note right of BorrowService
  借书流程:
  1. 检查库存
  2. 检查是否已借
  3. 创建借阅记录
  4. 减少库存
  5. 设置应还时间(60天)
  
  还书流程:
  1. 更新借阅状态
  2. 增加库存
  3. 增加用户积分
end note
@enduml
```

### 10.3 推荐算法流程

```plantuml
@startuml 推荐算法流程
skinparam classAttributeIconSize 0

class RecommendController {
  --
  + getRecommendations(userId): List<Book>
}

class CollaborativeFilteringEngine {
  --
  + recommend(userId): List<Book>
  - buildMatrix(): Matrix
  - calculateSimilarity(): Matrix
  - findSimilarUsers(userId): List<User>
  - getRecommendedBooks(similarUsers): List<Book>
}

class MatrixBuilder {
  --
  + buildUserItemMatrix(): Matrix
  + getRating(user, book): float
}

class SimilarityCalculator {
  --
  + cosineSimilarity(matrix): Matrix
}

class BookFilter {
  --
  + filterUserBooks(userId, books): List<Book>
  + sortByScore(books): List<Book>
}

class UserBehaviorRepository {
  --
  + getCollectedBooks(userId): List<Book>
  + getWishBooks(userId): List<Book>
}

RecommendController --> CollaborativeFilteringEngine
CollaborativeFilteringEngine --> MatrixBuilder
CollaborativeFilteringEngine --> SimilarityCalculator
CollaborativeFilteringEngine --> BookFilter
CollaborativeFilteringEngine --> UserBehaviorRepository

note right of CollaborativeFilteringEngine
  协同过滤算法:
  1. 构建用户-图书评分矩阵
     - 收藏: 1.0分
     - 心愿: 0.5分
  2. 计算用户相似度(余弦)
  3. 找到K个最相似用户
  4. 推荐相似用户喜欢的书
  5. 过滤已接触图书
  6. 返回Top N推荐
end note
@enduml
```

---

## 使用说明

1. **复制代码**：每个类图代码块都可以直接在PlantUML中使用
2. **在线编辑**：访问 http://www.plantuml.com/plantuml/ 粘贴代码即可查看
3. **本地渲染**：
   - 安装PlantUML插件（VS Code、IntelliJ等）
   - 或使用PlantUML命令行工具
4. **导出图片**：可导出为PNG、SVG等格式

## 类图说明

- **实线箭头**：关联关系
- **虚线箭头**：依赖关系
- **空心三角**：继承关系
- **实心菱形**：组合关系
- **空心菱形**：聚合关系
- **数字标注**：表示关联的多重性（1对多、多对多等）
