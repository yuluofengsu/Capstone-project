# # 社区化图书共享与推荐平台 - 系统模块详细设计说明

**文档版本**：1.0  
**最后更新**：2024年  
**设计者**：Capstone Project Team  

---

## 目录

1. [系统概述](#系统概述)
2. [Part I - 系统架构设计](#part-i---系统架构设计)
   - [3.1 用户信息管理模块](#31-用户信息管理模块)
   - [3.2 图书信息管理模块](#32-图书信息管理模块)
   - [3.3 借阅管理模块](#33-借阅管理模块)
   - [3.4 评论与内容管理模块](#34-评论与内容管理模块)
   - [3.5 社区互动模块](#35-社区互动模块)
   - [3.6 系统日志管理模块](#36-系统日志管理模块)
   - [3.7 系统管理模块](#37-系统管理模块)
   - [3.8 前端架构设计](#38-前端架构设计)
   - [3.9 后端架构设计](#39-后端架构设计)
3. [Part II - 数据库设计](#part-ii---数据库设计)
   - [4.1 设计原则](#41-设计原则)
   - [4.2 实体详细说明](#42-实体详细说明)
   - [4.3 实体关系概述](#43-实体关系概述)
   - [4.4 索引与性能优化](#44-索引与性能优化)
   - [4.5 迁移与兼容性](#45-迁移与兼容性)
   - [4.6 总结](#46-总结)

---

## 系统概述

**社区化图书共享与推荐平台**是一个全栈Web应用，旨在为用户提供图书借阅、推荐、社区互动等功能。系统采用前后端分离架构，前端采用**Vue 2.x**，后端采用**Django 4.1.4 + Django REST Framework**，支持**MySQL/SQLite**双数据库。

### 核心特性

- ✅ **双认证机制**：前台用户Token认证 + 后台管理员Token认证
- ✅ **完整的借阅流程**：借阅、还书、延期、库存管理
- ✅ **社区互动**：用户发帖、评论、点赞、活动参与
- ✅ **个性化推荐**：基于用户行为的图书推荐算法
- ✅ **运营管理**：广告、横幅、通知、活动后台管理
- ✅ **审计日志**：登录日志、操作日志、错误日志记录

---

# Part I - 系统架构设计

## 3.1 用户信息管理模块

### 3.1.1 模块功能概述

用户信息管理模块负责系统的身份认证、用户账户管理、个人信息维护等功能。分为两套独立的认证系统：

- **前台用户系统**：普通用户的注册、登录、个人信息管理
- **后台管理系统**：管理员的登录认证、权限控制

### 3.1.2 用户信息模型

| 字段名 | 数据类型 | 长度 | 默认值 | 说明 |
|-------|--------|------|-------|------|
| id | BigAutoField | - | - | 主键，自增长 |
| username | CharField | 50 | - | 用户名/邮箱，唯一 |
| password | CharField | 128 | - | MD5加密密码 |
| role | CharField | 2 | '1' | 用户角色（0-管理员，1-普通用户，2-演示账户） |
| status | CharField | 1 | '0' | 账户状态（0-正常，1-封号） |
| nickname | CharField | 100 | NULL | 用户昵称 |
| avatar | FileField | - | NULL | 用户头像，上传路径avatar/ |
| mobile | CharField | 13 | NULL | 手机号码 |
| email | CharField | 50 | NULL | 邮箱 |
| gender | CharField | 1 | NULL | 性别（M-男，F-女） |
| description | TextField | 200 | NULL | 个人简介 |
| create_time | DateTimeField | - | - | 创建时间，自动添加 |
| score | IntegerField | - | 0 | 用户积分 |
| token | CharField | 255 | NULL | 前台用户token |
| admin_token | CharField | 255 | NULL | 后台管理员token |

**安全说明**：
- 密码使用MD5加密存储（当前实现），建议生产环境迁移至更安全的哈希方案（bcrypt/argon2）并加入salt
- 前端通过`token`或`adminToken` HTTP头传递认证凭证
- 后端使用`TokenAuthentication`与`AdminTokenAuthentication`解析并校验角色权限

### 3.1.3 前台用户API设计

#### 用户登录

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/user/login` |
| **请求参数** | `username` (邮箱)、`password` (密码) |
| **认证要求** | 无 |
| **响应示例** | `{"code": 0, "msg": "登录成功", "data": {...user_data}}` |
| **业务逻辑** | 验证用户名密码 → MD5加密比对 → 生成token → 记录登录日志 |
| **错误处理** | 用户不存在、密码错误、账户被封号 |

#### 用户注册

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/user/register` |
| **请求参数** | `username` (邮箱)、`password` (密码)、`repassword` (确认密码) |
| **认证要求** | 无 |
| **响应示例** | `{"code": 0, "msg": "注册成功", "data": {...user_data}}` |
| **业务逻辑** | 检查参数有效性 → 检查邮箱唯一性 → MD5加密密码 → 创建用户 |
| **错误处理** | 参数缺失、邮箱已存在、密码不一致 |

#### 查看用户信息

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/user/info` |
| **请求参数** | 无（从token中获取当前用户） |
| **认证要求** | `TokenAuthentication` (token) |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": {...user_data}}` |
| **业务逻辑** | 验证token有效性 → 获取当前用户信息 → 返回序列化数据 |
| **错误处理** | token无效、用户不存在 |

#### 修改用户信息

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/user/update` |
| **请求参数** | `nickname`、`avatar` (文件)、`gender`、`description` |
| **认证要求** | `TokenAuthentication` (token) |
| **响应示例** | `{"code": 0, "msg": "更新成功", "data": {...updated_user}}` |
| **业务逻辑** | 验证token → 处理文件上传 → 更新用户信息 → 返回更新后的用户数据 |
| **错误处理** | token无效、文件格式不支持、参数验证失败 |

#### 修改密码

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/user/updatePwd` |
| **请求参数** | `old_password` (旧密码)、`new_password` (新密码) |
| **认证要求** | `TokenAuthentication` (token) |
| **响应示例** | `{"code": 0, "msg": "密码修改成功"}` |
| **业务逻辑** | 验证token → 验证旧密码正确性 → MD5加密新密码 → 更新密码 |
| **错误处理** | token无效、旧密码错误、新密码格式不符 |

### 3.1.4 后台用户管理API设计

#### 管理员登录

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/adminLogin` |
| **请求参数** | `username` (邮箱)、`password` (密码) |
| **认证要求** | 无 |
| **响应示例** | `{"code": 0, "msg": "登录成功", "data": {...admin_data}}` |
| **业务逻辑** | 验证用户名密码 → 检查role为0（管理员） → 生成admin_token → 记录日志 |
| **错误处理** | 用户不存在、密码错误、账户非管理员 |

#### 用户列表查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/user/list` |
| **请求参数** | `keyword` (搜索关键词)、`page`、`limit` |
| **认证要求** | `AdminTokenAuthentication` (adminToken) |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...users]}` |
| **业务逻辑** | 验证adminToken → 按keyword模糊搜索用户 → 按创建时间降序排列 → 分页返回 |
| **错误处理** | token无效、权限不足 |

#### 创建用户

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/user/create` |
| **请求参数** | `username`、`password`、`nickname`、`email`、`role` |
| **认证要求** | `AdminTokenAuthentication` (adminToken) |
| **响应示例** | `{"code": 0, "msg": "创建成功", "data": {...new_user}}` |
| **业务逻辑** | 验证权限 → 检查邮箱唯一性 → MD5加密 → 保存用户 |
| **错误处理** | token无效、邮箱重复、演示账户限制操作 |

#### 更新用户信息

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/user/update` |
| **请求参数** | `id`、`nickname`、`email`、`role`、`status` |
| **认证要求** | `AdminTokenAuthentication` (adminToken) |
| **响应示例** | `{"code": 0, "msg": "更新成功", "data": {...updated_user}}` |
| **业务逻辑** | 验证权限 → 获取用户 → 更新字段 → 保存 |
| **错误处理** | 用户不存在、权限不足 |

#### 删除用户

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/user/delete` |
| **请求参数** | `id` |
| **认证要求** | `AdminTokenAuthentication` (adminToken) |
| **响应示例** | `{"code": 0, "msg": "删除成功"}` |
| **业务逻辑** | 验证权限 → 检查用户存在性 → 删除用户记录 → 级联删除相关数据 |
| **错误处理** | 用户不存在、演示账户限制、权限不足 |

### 3.1.5 认证与权限设计

#### TokenAuthentication认证类

| 属性 | 描述 |
|-----|------|
| **类名** | `TokenAuthentication` |
| **包名** | `myapp.auth.authentication` |
| **描述** | 前台用户token认证类，用于前台API的身份验证 |
| **继承** | `BaseAuthentication` |
| **主要方法** | `authenticate(request)` |
| **验证逻辑** | 1. 从请求头获取HTTP_TOKEN<br>2. 查询token对应的用户<br>3. token无效则抛出异常AUTH_FAIL_FRONT<br>4. 返回(user, token)元组 |
| **适用范围** | 前台所有受保护的API |

#### AdminTokenAuthentication认证类

| 属性 | 描述 |
|-----|------|
| **类名** | `AdminTokenAuthentication` |
| **包名** | `myapp.auth.authentication` |
| **描述** | 后台管理员token认证类，用于后台管理API的身份验证 |
| **继承** | `BaseAuthentication` |
| **主要方法** | `authenticate(request)` |
| **验证逻辑** | 1. 从请求头获取HTTP_ADMINTOKEN<br>2. 查询adminToken对应的用户<br>3. 检查用户role为0或3（管理员）<br>4. 无效则抛出异常AUTH_FAIL_END<br>5. 返回(user, admin_token)元组 |
| **适用范围** | 后台所有受保护的API |

---

## 3.2 图书信息管理模块

### 3.2.1 模块功能概述

图书信息管理模块实现平台图书的增删改查、分类标签管理、图书展示等功能。系统管理员可维护图书基本信息、设置上架/下架状态、管理图书分类和标签。普通用户可浏览图书列表、查看图书详情、添加到愿望单、收藏等操作。

该模块包含实体类Book、Classification、Tag，接口类BookService、ClassificationService、TagService，以及多层视图处理前后台不同的业务需求。

### 3.2.2 数据模型设计

#### Book模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键，自增长 |
| title | CharField | 255 | 图书标题 |
| original_title | CharField | 255 | 原始标题（用于外文书） |
| classification | ForeignKey | - | 关联分类 |
| tag | ManyToManyField | - | 关联标签（多个） |
| cover | ImageField | - | 图书封面，upload_to='cover/' |
| author | CharField | 50 | 作者 |
| translator | CharField | 50 | 译者 |
| description | TextField | 1000 | 图书简介 |
| press | CharField | 50 | 出版社 |
| page_count | IntegerField | - | 页数 |
| price | CharField | 50 | 价格 |
| isbn | CharField | 50 | ISBN编号 |
| pub_date | DateField | - | 出版日期 |
| online_time | DateTimeField | - | 上架时间 |
| status | CharField | 1 | 状态（0-上架，1-下架） |
| repertory | IntegerField | - | 库存数量 |
| score | CharField | 10 | 评分 |
| layout | CharField | 10 | 装帧类型 |
| create_time | DateTimeField | - | 创建时间 |
| pv | IntegerField | - | 浏览量 |
| recommend_count | IntegerField | - | 推荐次数 |
| wish | ManyToManyField | - | 愿望清单用户 |
| wish_count | IntegerField | - | 愿望清单数量 |
| collect | ManyToManyField | - | 收藏用户 |
| collect_count | IntegerField | - | 收藏数量 |

#### Classification模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| pid | IntegerField | - | 父分类ID（支持多级分类） |
| title | CharField | 100 | 分类名称 |
| create_time | DateTimeField | - | 创建时间 |

#### Tag模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 标签名称 |
| create_time | DateTimeField | - | 创建时间 |

### 3.2.3 前台图书展示API设计

#### 图书列表查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/book/list` |
| **请求参数** | `keyword`、`classification_id`、`tag_id`、`page`、`limit` |
| **认证要求** | `TokenAuthentication` (可选) |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...books]}` |
| **业务逻辑** | 获取所有上架图书 → 按分类/标签/关键词筛选 → 按推荐度/浏览量排序 → 分页返回 |
| **返回数据** | ListBookSerializer (不包含详细description) |

#### 图书详情查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/book/detail` |
| **请求参数** | `book_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": {...book_detail}}` |
| **业务逻辑** | 获取指定图书 → 增加浏览量(pv) → 获取相关评论 → 返回详细信息 |
| **返回数据** | DetailBookSerializer |

#### 添加愿望单

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/book/addWishUser` |
| **请求参数** | `book_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "添加成功"}` |
| **业务逻辑** | 验证token → 获取用户 → 检查是否已加入 → 添加到ManyToMany → 增加wish_count |
| **错误处理** | 重复添加 |

#### 移除愿望单

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/book/removeWishUser` |
| **请求参数** | `book_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "移除成功"}` |
| **业务逻辑** | 验证token → 移除用户 → 减少wish_count |

#### 获取愿望单列表

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/book/getWishBookList` |
| **请求参数** | `page`、`limit` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...wish_books]}` |
| **业务逻辑** | 获取当前用户的wish关系 → 分页返回相关图书 |

#### 添加收藏

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/book/addCollectUser` |
| **请求参数** | `book_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "收藏成功"}` |
| **业务逻辑** | 验证token → 添加到collect → 增加collect_count |

#### 获取收藏列表

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/book/getCollectBookList` |
| **请求参数** | `page`、`limit` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...collected_books]}` |
| **业务逻辑** | 获取当前用户的collect关系 → 分页返回相关图书 |

### 3.2.4 后台图书管理API设计

#### 图书列表管理

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/book/list` |
| **请求参数** | `keyword`、`status`、`classification_id`、`page`、`limit` |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...books]}` |
| **业务逻辑** | 查询所有图书 → 按条件筛选 → 返回完整信息 |

#### 创建图书

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/book/create` |
| **请求参数** | `title`、`author`、`press`、`description`、`cover` (文件)、`classification_id`等 |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "创建成功", "data": {...new_book}}` |
| **业务逻辑** | 验证权限 → 处理文件上传 → 创建图书记录 → 关联分类标签 |

#### 更新图书

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/book/update` |
| **请求参数** | `id`、`title`、`status`、`repertory`等 |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "更新成功", "data": {...updated_book}}` |
| **业务逻辑** | 验证权限 → 获取图书 → 更新字段 → 保存 |

#### 删除图书

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/book/delete` |
| **请求参数** | `id` |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "删除成功"}` |
| **业务逻辑** | 验证权限 → 删除图书 → 级联删除关联的评论、借阅记录 |

### 3.2.5 分类标签管理API设计

#### 分类列表查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/classification/list` (前台) / `/myapp/admin/classification/list` (后台) |
| **请求参数** | 无 |
| **认证要求** | 无 (前台) / `AdminTokenAuthentication` (后台) |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...classifications]}` |
| **业务逻辑** | 获取所有分类 → 按树形结构组织 |

#### 创建分类

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/admin/classification/create` |
| **请求参数** | `title`、`pid` (父分类ID，可选) |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "创建成功", "data": {...classification}}` |
| **业务逻辑** | 验证权限 → 检查分类名唯一性 → 创建分类 |

---

## 3.3 借阅管理模块

### 3.3.1 模块功能概述

借阅管理模块实现用户借阅图书、还书、延期等功能。用户可发起借阅申请、查看借阅历史、归还图书、申请延期。管理员可管理所有借阅记录、处理逾期情况、生成相关报表。

### 3.3.2 数据模型设计

#### Borrow模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| user | ForeignKey | - | 借阅用户 |
| book | ForeignKey | - | 被借图书 |
| status | CharField | 2 | 状态（1-借出，2-已还） |
| borrow_time | DateTimeField | - | 借出时间 |
| expect_time | DateTimeField | - | 应还时间 |
| return_time | DateTimeField | - | 实际还书时间 |
| delayed | BooleanField | - | 是否已延期 |

#### Address模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| user | ForeignKey | - | 所属用户 |
| name | CharField | 100 | 收货人名称 |
| mobile | CharField | 30 | 收货人电话 |
| desc | CharField | 300 | 详细地址 |
| default | BooleanField | - | 是否默认地址 |
| create_time | DateTimeField | - | 创建时间 |

### 3.3.3 借阅相关API设计

#### 创建借阅

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/borrow/create` |
| **请求参数** | `book_id`、`address_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "借阅成功", "data": {...borrow}}` |
| **业务逻辑** | 验证token → 检查地址 → 检查图书库存 → 创建借阅记录 → 减少库存 |
| **错误处理** | 库存不足、地址不存在 |

#### 借阅列表查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/borrow/list` |
| **请求参数** | `status`、`page`、`limit` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...borrows]}` |
| **业务逻辑** | 获取当前用户的借阅记录 → 按status筛选 → 分页返回 |

#### 还书

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/borrow/return_book` |
| **请求参数** | `borrow_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "还书成功"}` |
| **业务逻辑** | 验证token → 检查借阅记录 → 标记为已还 → 增加库存 → 记录还书时间 |

#### 延期

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/borrow/delay` |
| **请求参数** | `borrow_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "延期成功"}` |
| **业务逻辑** | 验证token → 检查延期次数 → 检查是否逾期 → 延长应还时间 → 标记delayed=True |
| **错误处理** | 超过延期次数、已逾期 |

### 3.3.4 地址管理API设计

#### 地址列表查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/address/list` |
| **请求参数** | 无 |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...addresses]}` |
| **业务逻辑** | 获取当前用户的所有地址 |

#### 创建地址

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/address/create` |
| **请求参数** | `name`、`mobile`、`desc`、`default` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "创建成功", "data": {...address}}` |
| **业务逻辑** | 验证token → 创建地址 → 若default=true，则清除其他默认标记 |

---

## 3.4 评论与内容管理模块

### 3.4.1 模块功能概述

评论与内容管理模块实现用户发表图书评论、管理员审核删除等功能。用户可对图书发表评论和评分，管理员可查看、删除不当评论。

### 3.4.2 数据模型设计

#### Comment模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| content | CharField | 200 | 评论内容 |
| user | ForeignKey | - | 评论用户 |
| book | ForeignKey | - | 被评图书 |
| comment_time | DateTimeField | - | 评论时间 |
| like_count | IntegerField | - | 点赞数 |

### 3.4.3 评论API设计

#### 图书评论列表

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/comment/list` |
| **请求参数** | `book_id`、`page`、`limit` |
| **认证要求** | 无 |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...comments]}` |
| **业务逻辑** | 获取指定图书的所有评论 → 按时间排序 → 分页返回 |

#### 我的评论列表

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/comment/listMyComments` |
| **请求参数** | `page`、`limit` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...my_comments]}` |
| **业务逻辑** | 获取当前用户的所有评论 → 分页返回 |

#### 发表评论

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/comment/create` |
| **请求参数** | `book_id`、`content` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "发表成功", "data": {...comment}}` |
| **业务逻辑** | 验证token → 检查是否已评论此书 → 创建评论记录 |
| **错误处理** | 重复评论 |

#### 删除评论

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/comment/delete` |
| **请求参数** | `comment_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "删除成功"}` |
| **业务逻辑** | 验证token → 检查权限（自己的评论或管理员） → 删除评论 |

---

## 3.5 社区互动模块

### 3.5.1 模块功能概述

社区互动模块实现用户发表帖子、评论、参与活动、点赞等功能。用户可发起讨论、交流阅读体验、参与平台活动。

### 3.5.2 数据模型设计

#### CommunityPost模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 帖子标题 |
| content | TextField | 2000 | 帖子内容 |
| user | ForeignKey | - | 发布用户 |
| create_time | DateTimeField | - | 创建时间 |
| views | IntegerField | - | 浏览数 |
| like_count | IntegerField | - | 点赞数 |
| liked_users | ManyToManyField | - | 点赞用户 |

#### ReadingEvent模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 活动标题 |
| description | TextField | 2000 | 活动描述 |
| cover | ImageField | - | 活动封面 |
| start_time | DateTimeField | - | 开始时间 |
| end_time | DateTimeField | - | 结束时间 |
| create_time | DateTimeField | - | 创建时间 |
| status | CharField | 1 | 状态（0-未开始，1-进行中，2-已结束） |

#### CommunityComment模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| content | CharField | 500 | 评论内容 |
| user | ForeignKey | - | 评论用户 |
| post | ForeignKey | - | 关联帖子 |
| event | ForeignKey | - | 关联活动 |
| create_time | DateTimeField | - | 创建时间 |
| like_count | IntegerField | - | 点赞数 |

### 3.5.3 社区API设计

#### 帖子列表

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/community/post/list` |
| **请求参数** | `page`、`limit`、`sort` (最新/热门) |
| **认证要求** | 无 |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...posts]}` |
| **业务逻辑** | 获取所有已发布帖子 → 按条件排序 → 分页返回 |

#### 发表帖子

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/community/post/create` |
| **请求参数** | `title`、`content` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "发表成功", "data": {...post}}` |
| **业务逻辑** | 验证token → 创建帖子记录 |

#### 点赞帖子

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/community/post/like` |
| **请求参数** | `post_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "点赞成功"}` |
| **业务逻辑** | 验证token → 检查是否已点赞 → 添加到liked_users → 增加like_count |

#### 删除帖子

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/community/post/delete` |
| **请求参数** | `post_id` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "删除成功"}` |
| **业务逻辑** | 验证token → 检查权限 → 删除帖子及相关评论 |

#### 帖子评论

| 属性 | 值 |
|-----|-----|
| **请求路径** | `POST /myapp/index/community/comment/create` |
| **请求参数** | `post_id`、`content` |
| **认证要求** | `TokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "评论成功", "data": {...comment}}` |
| **业务逻辑** | 验证token → 创建评论 |

---

## 3.6 系统日志管理模块

### 3.6.1 模块功能概述

系统日志管理模块记录用户登录日志、操作日志、错误日志等，供管理员查看和分析系统运行情况。

### 3.6.2 数据模型设计

#### LoginLog模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| username | CharField | 50 | 登录用户名 |
| ip | CharField | 100 | 登录IP地址 |
| ua | CharField | 200 | User-Agent信息 |
| log_time | DateTimeField | - | 登录时间 |

#### OpLog模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| re_ip | CharField | 100 | 请求IP |
| re_time | DateTimeField | - | 请求时间 |
| re_url | CharField | 200 | 请求URL |
| re_method | CharField | 10 | 请求方法(GET/POST) |
| re_content | CharField | 200 | 请求内容摘要 |
| access_time | CharField | 10 | 响应时间(ms) |

#### ErrorLog模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| ip | CharField | 100 | 请求IP |
| url | CharField | 200 | 错误URL |
| method | CharField | 10 | 请求方法 |
| content | CharField | 200 | 错误信息 |
| log_time | DateTimeField | - | 发生时间 |

### 3.6.3 日志查询API设计

#### 登录日志查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/loginLog/list` |
| **请求参数** | `username`、`start_date`、`end_date`、`page`、`limit` |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...logs]}` |
| **业务逻辑** | 验证权限 → 按条件筛选登录日志 → 分页返回 |

#### 操作日志查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/opLog/list` |
| **请求参数** | `keyword`、`method`、`page`、`limit` |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...logs]}` |
| **业务逻辑** | 验证权限 → 按URL/方法筛选 → 分页返回 |

#### 错误日志查询

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/errorLog/list` |
| **请求参数** | `url`、`keyword`、`page`、`limit` |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": [...logs]}` |
| **业务逻辑** | 验证权限 → 按URL/错误类型筛选 → 分页返回 |

---

## 3.7 系统管理模块

### 3.7.1 模块功能概述

系统管理模块提供管理员对广告、横幅、通知、活动等平台资源的管理功能。

### 3.7.2 数据模型设计

#### Banner模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| image | ImageField | - | 横幅图片 |
| book | ForeignKey | - | 关联图书 |
| create_time | DateTimeField | - | 创建时间 |

#### Ad模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| image | ImageField | - | 广告图片 |
| link | CharField | 500 | 链接地址 |
| create_time | DateTimeField | - | 创建时间 |

#### Notice模型

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 通知标题 |
| content | CharField | 1000 | 通知内容 |
| create_time | DateTimeField | - | 创建时间 |

### 3.7.3 系统资源管理API设计

#### 广告管理

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/ad/list` / `POST /myapp/admin/ad/create` / `POST /myapp/admin/ad/update` / `POST /myapp/admin/ad/delete` |
| **请求参数** | `image` (文件)、`link`、`id` |
| **认证要求** | `AdminTokenAuthentication` |
| **业务逻辑** | **列表**：查询所有广告<br>**创建**：上传图片，保存链接<br>**更新**：修改图片和链接<br>**删除**：删除广告记录 |

#### 横幅管理

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/banner/list` / `POST /myapp/admin/banner/create` / `POST /myapp/admin/banner/update` / `POST /myapp/admin/banner/delete` |
| **请求参数** | `image` (文件)、`book_id`、`id` |
| **认证要求** | `AdminTokenAuthentication` |
| **业务逻辑** | **列表**：查询所有横幅<br>**创建**：上传图片，关联图书<br>**更新**：修改图片和关联<br>**删除**：删除横幅记录 |

#### 通知管理

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/notice/list_api` (前台) / `POST /myapp/admin/notice/list` / `POST /myapp/admin/notice/create` / `POST /myapp/admin/notice/update` / `POST /myapp/admin/notice/delete` (后台) |
| **请求参数** | `title`、`content`、`id` |
| **认证要求** | 无 (前台列表) / `AdminTokenAuthentication` (后台) |
| **业务逻辑** | **列表**：查询通知<br>**创建**：创建新通知<br>**更新**：修改通知内容<br>**删除**：删除通知 |

#### 活动管理

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/index/community/event/list` (前台) / `POST /myapp/admin/event/list` / `POST /myapp/admin/event/create` / `POST /myapp/admin/event/update` / `POST /myapp/admin/event/delete` (后台) |
| **请求参数** | `title`、`description`、`cover` (文件)、`start_time`、`end_time`、`status` |
| **认证要求** | 无 (前台列表) / `AdminTokenAuthentication` (后台) |
| **业务逻辑** | **列表**：查询活动<br>**创建**：创建活动，上传封面<br>**更新**：修改活动信息<br>**删除**：删除活动 |

### 3.7.4 系统概览API设计

#### 数据统计

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/overview/count` |
| **请求参数** | 无 |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": {"user_count": 100, "book_count": 500, "borrow_count": 50, "comment_count": 200}}` |
| **业务逻辑** | 统计用户总数、图书总数、借阅总数、评论总数等关键指标 |

#### 系统信息

| 属性 | 值 |
|-----|-----|
| **请求路径** | `GET /myapp/admin/overview/sysInfo` |
| **请求参数** | 无 |
| **认证要求** | `AdminTokenAuthentication` |
| **响应示例** | `{"code": 0, "msg": "查询成功", "data": {"python_version": "3.x.x", "django_version": "4.x.x", "cpu_percent": 45, "memory_usage": 60}}` |
| **业务逻辑** | 获取服务器运行状态、Python/Django版本、系统资源使用情况 |

---

## 3.8 前端架构设计

### 3.8.1 框架技术栈

前端采用**Vue 2.x + Ant Design Vue + Vue Router + Vuex**的技术栈：

- **Vue 2.x**：渐进式JavaScript框架，提供响应式数据绑定和组件化开发
- **Ant Design Vue**：企业级UI组件库，提供丰富的表单、表格、弹框等组件
- **Vue Router**：前端路由管理，实现单页应用导航
- **Vuex**：状态管理库，集中管理用户认证、应用全局状态

### 3.8.2 项目目录结构

```
client/
├── src/
│   ├── api/                 # API层 - 分为admin和index两套接口
│   │   ├── admin/          # 后台管理API客户端
│   │   │   ├── user.js
│   │   │   ├── book.js
│   │   │   ├── banner.js
│   │   │   └── ...
│   │   └── index/          # 前台用户API客户端
│   │       ├── user.js
│   │       ├── book.js
│   │       ├── borrow.js
│   │       └── ...
│   ├── views/              # 页面组件 - 分为admin和index两套路由
│   │   ├── admin/          # 后台管理页面
│   │   └── index/          # 前台用户页面
│   ├── router/             # 路由配置 - 分前台/后台两套路由
│   │   └── index.js        # 路由总配置
│   ├── store/              # Vuex状态管理
│   │   ├── constants.js    # BASE_URL、TOKEN_KEY等常量
│   │   ├── index.js        # store入口
│   │   └── modules/
│   │       └── user.js     # user状态模块（token、admin_token等）
│   ├── components/         # 全局共享组件
│   ├── utils/              # 工具函数
│   │   ├── request.js      # axios拦截器 - 处理token自动附加和403错误
│   │   ├── util.js         # 通用工具
│   │   └── global.js       # 全局变量
│   ├── style/              # 全局样式(LESS)
│   │   ├── index.less
│   │   ├── _var.less
│   │   └── scrollbar.less
│   ├── assets/             # 静态资源
│   │   └── images/
│   └── main.js             # 应用入口
├── index.html
├── jsconfig.json
├── package.json
├── vue.config.js
└── build/                  # webpack构建配置
```

### 3.8.3 API客户端设计模式

每个资源的API客户端遵循统一的设计模式：

```javascript
// client/src/api/index/book.js
import axios from '@/utils/request.js'

const api = {
  listApi: '/myapp/index/book/list',
  detailApi: '/myapp/index/book/detail',
  addWishUserApi: '/myapp/index/book/addWishUser',
  removeWishUserApi: '/myapp/index/book/removeWishUser',
  // ... 其他端点
}

export const listApi = function (data) {
  return axios({
    url: api.listApi,
    method: 'get',
    params: data
  })
}

export const detailApi = function (data) {
  return axios({
    url: api.detailApi,
    method: 'get',
    params: data
  })
}

// ... 其他接口函数
```

**设计特点**：
- 每个资源单独创建API文件
- 每个API函数单独导出，便于树摇和组件导入
- 统一使用`axios`实例（已配置拦截器）
- 参数通过`params` (GET) 或`data` (POST) 传递

### 3.8.4 Vuex状态管理设计

状态管理分为**前台用户状态**和**后台管理员状态**两套独立的模块：

#### 用户状态结构

| 状态字段 | 类型 | 说明 |
|--------|------|------|
| token | String | 前台用户token |
| username | String | 前台用户名 |
| userId | Number | 前台用户ID |
| adminToken | String | 后台管理员token |
| adminUserName | String | 后台管理员名 |
| adminUserId | Number | 后台管理员ID |

#### 状态管理流程

```javascript
// store/modules/user.js 示例

const state = {
  token: localStorage.getItem('TOKEN') || '',
  username: '',
  userId: '',
  adminToken: localStorage.getItem('ADMIN_TOKEN') || '',
  adminUserName: '',
  adminUserId: ''
}

const mutations = {
  setToken(state, token) {
    state.token = token
    localStorage.setItem('TOKEN', token)
  },
  setAdminToken(state, adminToken) {
    state.adminToken = adminToken
    localStorage.setItem('ADMIN_TOKEN', adminToken)
  },
  // ... 其他mutations
}

const actions = {
  // 异步操作：API调用
  // 提交mutations更新状态
}
```

### 3.8.5 请求拦截器设计

**utils/request.js** 是所有API调用的核心拦截器：

| 功能 | 说明 |
|-----|------|
| **请求拦截** | 自动附加token和adminToken到请求头<br>Headers: `{'token': value, 'adminToken': value}` |
| **响应拦截** | 处理403认证失败 → 触发`Logout`/`AdminLogout` action<br>清空状态 → 跳转登录页 |
| **错误处理** | 统一处理API错误响应<br>消息提示和日志记录 |

---

## 3.9 后端架构设计

### 3.9.1 框架技术栈

后端采用**Django 4.1.4 + Django REST Framework**的技术栈：

- **Django**：Python高级Web框架，提供ORM、中间件、URL路由等功能
- **Django REST Framework (DRF)**：构建RESTful API的强大工具，提供序列化、认证、权限等功能
- **MySQL/SQLite**：关系型数据库，支持生产环境和开发环境切换

### 3.9.2 项目目录结构

```
server/
├── bookproject/            # Django主项目配置
│   ├── settings.py        # 项目设置(数据库、CORS、中间件配置)
│   ├── urls.py            # 路由总入口
│   ├── wsgi.py            # WSGI入口
│   ├── asgi.py            # ASGI入口
│   └── __init__.py
├── myapp/                 # 业务应用
│   ├── models.py          # ORM模型(User、Book、Borrow等)
│   ├── serializers.py     # DRF序列化器
│   ├── urls.py            # 业务路由映射
│   ├── views/             # 视图层
│   │   ├── admin/         # 后台管理API视图
│   │   │   ├── user.py
│   │   │   ├── book.py
│   │   │   ├── banner.py
│   │   │   └── ...
│   │   └── index/         # 前台用户API视图
│   │       ├── user.py
│   │       ├── book.py
│   │       ├── borrow.py
│   │       └── ...
│   ├── auth/              # 认证模块
│   │   ├── authentication.py  # TokenAuthentication、AdminTokenAuthentication
│   │   └── __init__.py
│   ├── permission/        # 权限模块
│   │   ├── permission.py  # 自定义权限类
│   │   └── __init__.py
│   ├── middlewares/       # 中间件
│   │   ├── LogMiddleware.py   # 操作日志中间件
│   │   └── __init__.py
│   ├── migrations/        # 数据库迁移
│   │   ├── 0001_initial.py
│   │   ├── 0002_*.py
│   │   └── __init__.py
│   ├── recommend_books/   # 推荐算法模块
│   │   ├── recommend.py
│   │   └── __init__.py
│   ├── spider/            # 豆瓣图书爬虫
│   │   └── 豆瓣图书.py
│   ├── handler.py         # API响应处理器(APIResponse)
│   ├── utils.py           # 工具函数
│   ├── admin.py           # Django admin配置
│   ├── apps.py
│   ├── tests.py
│   └── __init__.py
├── upload/                # 文件上传目录
│   ├── ad/                # 广告图片
│   ├── avatar/            # 用户头像
│   ├── banner/            # 横幅图片
│   ├── cover/             # 图书封面
│   ├── event/             # 活动封面
│   └── img/               # 其他图片
├── manage.py              # Django管理命令
├── requirements.txt       # 项目依赖
└── db.sqlite3            # SQLite数据库(开发环境)
```

### 3.9.3 URL路由约定

后端遵循统一的RESTful URL设计：

| 路由类型 | URL格式 | 示例 | HTTP方法 | 说明 |
|---------|--------|------|---------|------|
| 前台列表 | `/myapp/index/{resource}/list` | `/myapp/index/book/list` | GET | 获取资源列表 |
| 前台详情 | `/myapp/index/{resource}/detail` | `/myapp/index/book/detail` | GET | 获取资源详情 |
| 前台创建 | `/myapp/index/{resource}/create` | `/myapp/index/comment/create` | POST | 创建资源 |
| 前台删除 | `/myapp/index/{resource}/delete` | `/myapp/index/comment/delete` | POST | 删除资源 |
| 后台列表 | `/myapp/admin/{resource}/list` | `/myapp/admin/book/list` | GET | 获取资源列表 |
| 后台详情 | `/myapp/admin/{resource}/detail` | `/myapp/admin/book/detail` | GET | 获取资源详情 |
| 后台创建 | `/myapp/admin/{resource}/create` | `/myapp/admin/book/create` | POST | 创建资源 |
| 后台更新 | `/myapp/admin/{resource}/update` | `/myapp/admin/book/update` | POST | 更新资源 |
| 后台删除 | `/myapp/admin/{resource}/delete` | `/myapp/admin/book/delete` | POST | 删除资源 |

### 3.9.4 视图函数设计模式

每个视图函数遵循统一的设计模式，使用装饰器处理认证和权限：

```python
# myapp/views/index/book.py 示例
from rest_framework.decorators import api_view, authentication_classes
from myapp.auth.authentication import TokenAuthentication
from myapp.handler import APIResponse

@api_view(['GET'])
@authentication_classes([TokenAuthentication])
def list_api(request):
    """
    业务逻辑三步曲：
    1. 权限验证 - 由@authentication_classes装饰器自动处理
    2. 业务处理 - 查询数据库、数据转换等
    3. 响应返回 - 统一使用APIResponse格式
    """
    try:
        # 业务逻辑
        books = Book.objects.filter(status='0')
        serializer = ListBookSerializer(books, many=True)
        return APIResponse(code=0, msg='查询成功', data=serializer.data)
    except Exception as e:
        return APIResponse(code=1, msg='查询失败')
```

### 3.9.5 序列化器设计

DRF序列化器用于模型数据的序列化和反序列化：

```python
# myapp/serializers.py 示例
class ListBookSerializer(serializers.ModelSerializer):
    """列表序列化器 - 用于列表展示，包含部分字段"""
    classification_title = serializers.ReadOnlyField(source='classification.title')
    
    class Meta:
        model = Book
        fields = ['id', 'title', 'author', 'cover', 'score', 'classification_title']

class DetailBookSerializer(serializers.ModelSerializer):
    """详情序列化器 - 用于详情展示，包含完整字段"""
    classification_title = serializers.ReadOnlyField(source='classification.title')
    
    class Meta:
        model = Book
        fields = '__all__'
    
    def to_representation(self, instance):
        """动态字段处理：代理豆瓣图片URL"""
        ret = super().to_representation(instance)
        if instance.cover and str(instance.cover).startswith('http'):
            ret['cover'] = rewrite_cover_url(str(instance.cover), ...)
        return ret
```

**设计特点**：
- 使用不同的序列化器适应不同场景（列表/详情）
- 关联字段使用`ReadOnlyField(source='...')`取值
- `to_representation()`方法用于动态字段处理
- 字段级验证和对象级验证分离

### 3.9.6 中间件与日志记录

系统配置了日志中间件自动记录所有API操作：

#### LogMiddleware功能

| 功能 | 说明 |
|-----|------|
| **请求记录** | 记录IP、URL、HTTP方法、请求时间戳等 |
| **响应记录** | 记录响应耗时(ms) |
| **错误记录** | 捕获未处理异常并记录错误日志 |
| **性能监控** | 识别慢查询和性能瓶颈 |

#### 日志表结构

| 日志表 | 记录内容 | 用途 |
|-------|--------|------|
| LoginLog | username、ip、ua、log_time | 用户登录审计 |
| OpLog | request_ip、url、method、params、response、access_time | 操作审计和性能监控 |
| ErrorLog | ip、url、method、error_content、log_time | 错误追踪和调试 |

---

# Part II - 数据库设计

## 4.1 设计原则

### 基本设计原则

本系统数据库设计遵循以下原则：

1. **规范化设计**：
   - 遵循第三范式（3NF），避免数据冗余
   - 使用外键建立表间关系，确保数据完整性
   - 创建合理的中间表支持多对多关系

2. **性能优化**：
   - 对常用查询字段建立索引
   - 避免大字段频繁检索
   - 使用分区和归档策略处理大表

3. **可扩展性**：
   - 表名统一使用`b_`前缀，便于识别和管理
   - 所有表使用`BigAutoField`作为主键，支持大规模系统扩展
   - 预留扩展字段应对业务需求变化

4. **安全性**：
   - 密码字段使用加密存储
   - 敏感信息不存储在明文字段
   - 使用时间戳记录操作历史

### 命名规范

| 规范 | 说明 | 示例 |
|-----|------|------|
| **表名前缀** | 所有表均以`b_`开头 | `b_user`、`b_book` |
| **主键命名** | 统一使用`id` | `id BIGINT PRIMARY KEY` |
| **外键命名** | 使用`{resource}_id`格式 | `user_id`、`book_id` |
| **时间字段** | 使用`_time`后缀 | `create_time`、`update_time` |
| **状态字段** | 使用`status`或`state` | `status VARCHAR(1)` |
| **计数字段** | 使用`_count`后缀 | `like_count`、`view_count` |
| **字符集** | 统一使用UTF8MB4 | 支持emoji和多语言 |

---

## 4.2 实体详细说明

### 4.2.1 b_user（用户表）

**表描述**：存储用户账户与基本资料，支持前台token与后台admin_token双令牌机制。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| username | VARCHAR | 50 | NOT NULL | - | 用户名/邮箱，UNIQUE |
| password | VARCHAR | 128 | NOT NULL | - | MD5加密密码 |
| nickname | VARCHAR | 100 | NULL | - | 用户昵称 |
| avatar | VARCHAR | 100 | NULL | - | 用户头像路径 |
| description | VARCHAR | 300 | NULL | - | 个人简介 |
| mobile | VARCHAR | 30 | NULL | - | 手机号码 |
| email | VARCHAR | 100 | NULL | - | 邮箱 |
| score | INT | - | NULL | 0 | 用户积分 |
| push | INT | - | NULL | 0 | 推送设置 |
| role | VARCHAR | 1 | NULL | '1' | 角色（0-管理员，1-普通用户，2-演示用户） |
| status | VARCHAR | 1 | NULL | '0' | 状态（0-正常，1-冻结） |
| token | VARCHAR | 255 | NULL | - | 前台认证令牌 |
| admin_token | VARCHAR | 255 | NULL | - | 后台认证令牌 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 密码存储使用MD5加密（当前实现），建议生产环境迁移至bcrypt/argon2
- 前端通过`token`或`adminToken` HTTP头传递认证凭证
- 后端使用`TokenAuthentication`和`AdminTokenAuthentication`进行验证
- role字段区分管理员、普通用户、演示账户
- status字段支持账户冻结功能

**关键索引**：
```sql
CREATE UNIQUE INDEX idx_username ON b_user(username);
CREATE INDEX idx_email ON b_user(email);
CREATE INDEX idx_token ON b_user(token);
CREATE INDEX idx_admin_token ON b_user(admin_token);
```

---

### 4.2.2 b_book（图书表）

**表描述**：存储平台中的图书信息，包括图书基本信息、库存、统计数据等。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| title | VARCHAR | 255 | NOT NULL | - | 图书标题 |
| original_title | VARCHAR | 255 | NULL | - | 原始标题（外文书用） |
| classification_id | BIGINT | - | NOT NULL | - | 分类ID，FK -> b_classification.id |
| cover | VARCHAR | 255 | NULL | - | 图书封面URL |
| author | VARCHAR | 50 | NULL | - | 作者 |
| translator | VARCHAR | 50 | NULL | - | 译者 |
| description | TEXT | - | NULL | - | 图书简介 |
| press | VARCHAR | 50 | NULL | - | 出版社 |
| page_count | INT | - | NULL | - | 页数 |
| price | VARCHAR | 50 | NULL | - | 价格 |
| isbn | VARCHAR | 50 | NULL | - | ISBN编号 |
| pub_date | DATE | - | NULL | - | 出版日期 |
| online_time | DATETIME | - | NULL | - | 上架时间 |
| status | VARCHAR | 1 | NULL | '0' | 状态（0-上架，1-下架） |
| repertory | INT | - | NOT NULL | 0 | 库存数量 |
| score | VARCHAR | 10 | NULL | - | 评分 |
| layout | VARCHAR | 10 | NULL | - | 装帧类型 |
| pv | INT | - | NULL | 0 | 浏览量 |
| recommend_count | INT | - | NULL | 0 | 推荐次数 |
| wish_count | INT | - | NULL | 0 | 愿望清单数量 |
| collect_count | INT | - | NULL | 0 | 收藏数量 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 图书与分类为多对一关系，`classification_id`为外键
- 图书与标签为多对多关系，通过中间表`b_book_tag`实现（Django ORM自动创建）
- `repertory`字段记录当前库存，借阅时自动扣减，还书时自动增加
- `pv`、`recommend_count`、`wish_count`、`collect_count`为统计字段，需定期更新
- `status`字段控制图书上架/下架状态

**关键索引**：
```sql
CREATE INDEX idx_classification_id ON b_book(classification_id);
CREATE INDEX idx_title ON b_book(title);
CREATE INDEX idx_isbn ON b_book(isbn);
CREATE INDEX idx_status ON b_book(status);
```

---

### 4.2.3 b_classification（分类表）

**表描述**：用于图书浏览、筛选、后台管理。支持多级分类（树形结构）。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| title | VARCHAR | 255 | NOT NULL | - | 分类名称 |
| pid | BIGINT | - | NULL | 0 | 父分类ID，顶级为0或NULL |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 支持多级分类，通过`pid`字段建立父子关系
- 顶级分类的`pid`为0或NULL
- 可通过递归查询获取完整的分类树

**关键索引**：
```sql
CREATE INDEX idx_pid ON b_classification(pid);
CREATE UNIQUE INDEX idx_title ON b_classification(title);
```

---

### 4.2.4 b_tag（标签表）

**表描述**：为图书提供多维度标记，系统通过中间表（ORM ManyToMany）与`b_book`建立多对多关系。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| name | VARCHAR | 100 | NOT NULL | - | 标签名称 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 标签与图书为多对多关系，Django ORM自动创建中间表`b_book_tag`
- 支持灵活的标签搜索和聚合

**关键索引**：
```sql
CREATE UNIQUE INDEX idx_name ON b_tag(name);
```

---

### 4.2.5 b_borrow（借阅记录表）

**表描述**：记录用户借阅图书的事务信息，包括借出、还书、延期等操作。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| user_id | BIGINT | - | NOT NULL | - | 借阅用户ID，FK -> b_user.id |
| book_id | BIGINT | - | NOT NULL | - | 被借图书ID，FK -> b_book.id |
| borrow_time | DATETIME | - | NOT NULL | - | 借出时间 |
| expect_time | DATETIME | - | NOT NULL | - | 应还时间（通常为借出时间+30天） |
| return_time | DATETIME | - | NULL | - | 实际还书时间 |
| status | VARCHAR | 1 | NOT NULL | '1' | 状态（1-借阅中，2-已归还） |
| delayed | TINYINT | 1 | NULL | 0 | 是否延期（0-否，1-是） |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 创建借阅记录时需校验图书库存，扣减`b_book.repertory`
- 还书时恢复库存并记录`return_time`
- 延期功能需检查延期次数限制（如最多延期3次）
- 支持逾期识别：当前时间 > `expect_time` && `status` == '1'

**关键索引**：
```sql
CREATE INDEX idx_user_id ON b_borrow(user_id);
CREATE INDEX idx_book_id ON b_borrow(book_id);
CREATE INDEX idx_status ON b_borrow(status);
CREATE INDEX idx_expect_time ON b_borrow(expect_time);
```

---

### 4.2.6 b_address（用户地址表）

**表描述**：用户收货地址表，支持多个地址与默认标识。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| user_id | BIGINT | - | NOT NULL | - | 用户ID，FK -> b_user.id |
| name | VARCHAR | 100 | NOT NULL | - | 收货人名称 |
| mobile | VARCHAR | 30 | NOT NULL | - | 收货人电话 |
| desc | VARCHAR | 300 | NOT NULL | - | 详细地址 |
| default | BOOLEAN | - | NULL | 0 | 是否为默认地址 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 用户可添加多个收货地址
- 当新地址设置为默认时，后台需将该用户其他地址的`default`字段置为false
- 删除地址前需检查是否有关联的待发货订单

**关键索引**：
```sql
CREATE INDEX idx_user_id ON b_address(user_id);
CREATE INDEX idx_default ON b_address(default);
```

---

### 4.2.7 b_comment（图书评论表）

**表描述**：用户对图书的评论与评分记录。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| content | TEXT | - | NOT NULL | - | 评论内容 |
| user_id | BIGINT | - | NOT NULL | - | 评论用户ID，FK -> b_user.id |
| book_id | BIGINT | - | NOT NULL | - | 被评图书ID，FK -> b_book.id |
| comment_time | DATETIME | - | NOT NULL | - | 评论时间 |
| like_count | INT | - | NULL | 0 | 点赞数 |

**业务说明**：
- 限制每个用户对同一本图书只能有一条评论（业务层校验）
- 评论删除时需清理相关的点赞记录

**关键索引**：
```sql
CREATE INDEX idx_user_id ON b_comment(user_id);
CREATE INDEX idx_book_id ON b_comment(book_id);
CREATE UNIQUE INDEX idx_user_book ON b_comment(user_id, book_id);
```

---

### 4.2.8 b_community_post（社区帖子表）

**表描述**：用于用户发表帖子、参与讨论。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| title | VARCHAR | 100 | NOT NULL | - | 帖子标题 |
| content | TEXT | - | NOT NULL | - | 帖子内容 |
| user_id | BIGINT | - | NOT NULL | - | 发布用户ID，FK -> b_user.id |
| pv | INT | - | NULL | 0 | 浏览次数 |
| like_count | INT | - | NULL | 0 | 点赞数 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 帖子与用户为多对一关系
- 帖子与点赞用户为多对多关系，通过中间表实现防重复点赞
- `pv`统计帖子浏览次数

**关键索引**：
```sql
CREATE INDEX idx_user_id ON b_community_post(user_id);
CREATE INDEX idx_create_time ON b_community_post(create_time);
```

---

### 4.2.9 b_community_comment（社区评论表）

**表描述**：用于用户评论帖子或活动。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| post_id | BIGINT | - | NULL | - | 关联帖子ID，FK -> b_community_post.id |
| user_id | BIGINT | - | NOT NULL | - | 评论用户ID，FK -> b_user.id |
| content | VARCHAR | 500 | NOT NULL | - | 评论内容 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间 |
| like_count | INT | - | NULL | 0 | 点赞数 |

**业务说明**：
- 社区评论可关联帖子或活动
- 支持嵌套评论结构（需扩展`parent_id`字段）

**关键索引**：
```sql
CREATE INDEX idx_post_id ON b_community_comment(post_id);
CREATE INDEX idx_user_id ON b_community_comment(user_id);
```

---

### 4.2.10 b_reading_event（阅读活动表）

**表描述**：平台组织的线上/线下活动记录，用于增强社群粘性。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| title | VARCHAR | 100 | NOT NULL | - | 活动标题 |
| description | TEXT | - | NOT NULL | - | 活动描述 |
| cover | VARCHAR | 255 | NULL | - | 活动封面图片路径 |
| start_time | DATETIME | - | NOT NULL | - | 活动开始时间 |
| end_time | DATETIME | - | NOT NULL | - | 活动结束时间 |
| status | VARCHAR | 1 | NULL | '0' | 活动状态（0-未开始，1-进行中，2-已结束） |
| create_time | DATETIME | - | NOT NULL | - | 创建时间，自动添加 |

**业务说明**：
- 活动状态可根据当前时间自动判断：
  - 当前时间 < `start_time` → 未开始（0）
  - `start_time` <= 当前时间 <= `end_time` → 进行中（1）
  - 当前时间 > `end_time` → 已结束（2）

**关键索引**：
```sql
CREATE INDEX idx_status ON b_reading_event(status);
CREATE INDEX idx_start_time ON b_reading_event(start_time);
```

---

### 4.2.11 b_banner（横幅表）

**表描述**：平台首页/顶部横幅管理。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| image | VARCHAR | 255 | NOT NULL | - | 横幅图片路径 |
| book_id | BIGINT | - | NULL | - | 关联图书ID（点击跳转），FK -> b_book.id |
| create_time | DATETIME | - | NOT NULL | - | 创建时间 |

---

### 4.2.12 b_ad（广告表）

**表描述**：平台广告位管理。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| image | VARCHAR | 255 | NOT NULL | - | 广告图片路径 |
| link | VARCHAR | 500 | NOT NULL | - | 广告链接地址 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间 |

---

### 4.2.13 b_notice（通知表）

**表描述**：平台公告信息管理。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| title | VARCHAR | 100 | NOT NULL | - | 公告标题 |
| content | TEXT | - | NOT NULL | - | 公告内容 |
| create_time | DATETIME | - | NOT NULL | - | 创建时间 |

---

### 4.2.14 b_login_log（登录日志表）

**表描述**：记录用户登录事件，用于安全审计。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| username | VARCHAR | 50 | NOT NULL | - | 登录用户名 |
| ip | VARCHAR | 100 | NOT NULL | - | 登录IP地址 |
| ua | VARCHAR | 200 | NULL | - | User-Agent信息 |
| log_time | DATETIME | - | NOT NULL | - | 登录时间 |

**关键索引**：
```sql
CREATE INDEX idx_username ON b_login_log(username);
CREATE INDEX idx_log_time ON b_login_log(log_time);
```

---

### 4.2.15 b_op_log（操作日志表）

**表描述**：记录所有API操作，用于审计和性能监控。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| request_ip | VARCHAR | 100 | NOT NULL | - | 请求IP |
| request_url | VARCHAR | 200 | NOT NULL | - | 请求URL |
| request_method | VARCHAR | 10 | NOT NULL | - | 请求方法(GET/POST等) |
| access_time | INT | - | NULL | - | 响应时间(毫秒) |
| create_time | DATETIME | - | NOT NULL | - | 请求时间 |

**关键索引**：
```sql
CREATE INDEX idx_request_url ON b_op_log(request_url);
CREATE INDEX idx_request_method ON b_op_log(request_method);
CREATE INDEX idx_create_time ON b_op_log(create_time);
```

---

### 4.2.16 b_error_log（错误日志表）

**表描述**：记录系统错误和异常，用于问题定位和修复。

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|-------|--------|------|---------|-------|------|
| id | BIGINT | - | NOT NULL | - | 主键，自增长 |
| ip | VARCHAR | 100 | NOT NULL | - | 请求IP |
| url | VARCHAR | 200 | NOT NULL | - | 错误URL |
| method | VARCHAR | 10 | NOT NULL | - | 请求方法 |
| content | TEXT | - | NOT NULL | - | 错误信息/堆栈跟踪 |
| log_time | DATETIME | - | NOT NULL | - | 发生时间 |

**关键索引**：
```sql
CREATE INDEX idx_url ON b_error_log(url);
CREATE INDEX idx_log_time ON b_error_log(log_time);
```

---

## 4.3 实体关系概述

### 关键关系描述

| 关系 | 类型 | 描述 |
|-----|-----|------|
| b_user - b_address | 一对多 | 用户可有多个地址 |
| b_book - b_classification | 多对一 | 图书属于一个分类 |
| b_book - b_tag | 多对多 | 图书可有多个标签（通过中间表b_book_tag） |
| b_user - b_book (wish) | 多对多 | 用户的愿望清单（通过Django ORM实现） |
| b_user - b_book (collect) | 多对多 | 用户的收藏列表（通过Django ORM实现） |
| b_user - b_borrow | 一对多 | 用户可有多条借阅记录 |
| b_book - b_borrow | 一对多 | 一本书会有多次借阅记录 |
| b_user - b_comment | 一对多 | 用户可发表多条评论 |
| b_book - b_comment | 一对多 | 一本书可有多条评论 |
| b_community_post - b_community_comment | 一对多 | 一个帖子可有多条评论 |
| b_community_post - b_user (liked) | 多对多 | 帖子点赞用户关系 |

### 中间表说明

Django ORM自动创建以下中间表：

| 中间表 | 主表 | 关联表 | 用途 |
|-------|-----|--------|------|
| b_book_tag | b_book | b_tag | 图书与标签的多对多关系 |
| b_book_wish_users | b_book | b_user | 图书愿望清单 |
| b_book_collect_users | b_book | b_user | 图书收藏列表 |
| b_community_post_liked_users | b_community_post | b_user | 帖子点赞用户 |

---

## 4.4 索引与性能优化

### 推荐的索引策略

#### 主键索引（自动创建）
```sql
-- 所有表都有主键索引
ALTER TABLE b_user ADD PRIMARY KEY (id);
ALTER TABLE b_book ADD PRIMARY KEY (id);
-- ...
```

#### 外键索引（提升JOIN性能）
```sql
CREATE INDEX idx_user_id ON b_borrow(user_id);
CREATE INDEX idx_book_id ON b_borrow(book_id);
CREATE INDEX idx_classification_id ON b_book(classification_id);
```

#### 搜索字段索引
```sql
CREATE INDEX idx_username ON b_user(username);
CREATE INDEX idx_title ON b_book(title);
CREATE INDEX idx_isbn ON b_book(isbn);
```

#### 状态字段索引（频繁过滤）
```sql
CREATE INDEX idx_status ON b_book(status);
CREATE INDEX idx_borrow_status ON b_borrow(status);
```

#### 时间字段索引（日志查询）
```sql
CREATE INDEX idx_create_time ON b_user(create_time);
CREATE INDEX idx_log_time ON b_login_log(log_time);
CREATE INDEX idx_expect_time ON b_borrow(expect_time);
```

### 性能优化建议

#### 1. 统计字段优化

对于高并发写入的统计字段（如`pv`、`wish_count`、`like_count`）：

**方案一：缓存合并**
```
短期内的计数更新 → Redis缓存 → 定期批量更新数据库
```

**方案二：异步消息队列**
```
计数事件 → RabbitMQ/Redis Streams → 消费端聚合 → 数据库更新
```

#### 2. 大字段查询优化

对于大文本字段（`description`、`content`）：

- 使用MySQL FULLTEXT索引进行全文检索
- 或者集成ElasticSearch进行分布式搜索
- 分离大字段到专用表，主表仅保留摘要

#### 3. 慢查询优化

监控慢查询日志，优化：
- 多表JOIN操作：使用合理的索引
- 大数据量分页：使用游标分页或基于ID的分页
- 复杂的WHERE条件：确保条件字段都有索引

#### 4. 数据库参数调优

```ini
# MySQL优化参数示例
[mysqld]
# 缓冲池大小（根据服务器内存调整）
innodb_buffer_pool_size = 8G

# 并发连接数
max_connections = 1000

# 查询缓存
query_cache_size = 256M
query_cache_type = 1

# 慢查询日志
slow_query_log = 1
long_query_time = 2
```

---

## 4.5 迁移与兼容性

### 字符集与排序规则

生产部署时，建议统一使用UTF8MB4字符集：

```sql
-- 创建数据库时指定字符集
CREATE DATABASE book_sharing 
  CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

-- 修改现有表的字符集
ALTER TABLE b_user 
  CONVERT TO CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;
```

**优势**：
- 支持4字节UTF-8编码（emoji表情、生僻字）
- 兼容所有国际语言
- 避免字符截断问题

### 密码哈希升级

若需将密码哈希策略升级（MD5 → bcrypt/argon2）：

**迁移策略**：

1. **保留旧哈希字段用于兼容**
```python
# 迁移脚本
if is_md5_hash(old_password):
    # 用户下次登录时重新计算
    new_password = bcrypt_hash(user_input_password)
    user.password = new_password
    user.save()
```

2. **触发重新哈希的场景**：
   - 用户登录时
   - 用户修改密码时
   - 管理员强制重置密码时

3. **兼容期**：
   - 支持两种哈希方式同时验证
   - 直到所有用户完成迁移

### 数据库迁移命令

```bash
# 首次初始化数据库
python manage.py migrate

# 生成新的迁移文件
python manage.py makemigrations

# 应用迁移
python manage.py migrate

# 显示迁移状态
python manage.py showmigrations

# 回滚到特定迁移
python manage.py migrate myapp 0001_initial
```

---

## 4.6 总结

本部分基于代码和`book_1.sql`数据库结构，整理并规范化了系统的数据库设计说明。

### 核心成就

✅ **完整的表结构设计**：16张业务表（b_开头）覆盖平台核心功能  
✅ **科学的关系设计**：一对多、多对多关系清晰，支持复杂业务场景  
✅ **优化的性能指标**：关键字段建立索引，支持高并发查询  
✅ **规范化的命名**：统一的前缀、字段命名规范，便于维护  
✅ **灵活的扩展机制**：使用BigAutoField和预留字段，支持系统扩展  

### 下一步工作

如需进一步深化设计，可执行：

1. **生成ER图**：使用MySQL Workbench或draw.io绘制实体关系图
2. **性能基准测试**：建立测试数据集，进行并发性能测试
3. **容量规划**：根据业务增长预测，制定数据库扩容方案
4. **备份策略**：实施定期备份和灾难恢复计划

---

## 附录 - 快速参考

### 表名速查表

| 表名 | 用途 |
|-----|------|
| b_user | 用户账户和基本信息 |
| b_book | 图书基本信息 |
| b_classification | 图书分类 |
| b_tag | 图书标签 |
| b_borrow | 借阅记录 |
| b_address | 用户地址 |
| b_comment | 图书评论 |
| b_community_post | 社区帖子 |
| b_community_comment | 社区评论 |
| b_reading_event | 阅读活动 |
| b_banner | 首页横幅 |
| b_ad | 广告位 |
| b_notice | 平台通知 |
| b_login_log | 登录日志 |
| b_op_log | 操作日志 |
| b_error_log | 错误日志 |

### URL路由速查表

| 功能 | 请求路径 | HTTP方法 |
|-----|---------|---------|
| 用户登录 | `/myapp/index/user/login` | POST |
| 用户注册 | `/myapp/index/user/register` | POST |
| 图书列表 | `/myapp/index/book/list` | GET |
| 图书详情 | `/myapp/index/book/detail` | GET |
| 创建借阅 | `/myapp/index/borrow/create` | POST |
| 发表评论 | `/myapp/index/comment/create` | POST |
| 发表帖子 | `/myapp/index/community/post/create` | POST |
| 管理员登录 | `/myapp/admin/adminLogin` | POST |
| 用户管理列表 | `/myapp/admin/user/list` | GET |
| 图书管理列表 | `/myapp/admin/book/list` | GET |
| 数据统计 | `/myapp/admin/overview/count` | GET |

---

**文档完成** ✓

## 第3章 系统详细设计

本章详细说明社区化图书共享与推荐平台的各个模块设计，包括类图、接口定义、主要方法等内容。

---

## 3.1 用户信息管理模块设计

### 3.1.1 模块功能概述

用户信息管理模块实现用户身份认证、个人信息维护、地址管理等功能。普通用户可通过邮箱和密码进行注册和登录，修改个人信息（昵称、头像、性别等）、管理收货地址。系统管理员可以对用户账户进行冻结、解冻、重置密码、删除等操作，维护系统用户生态。

该模块采用**前后端分离架构**，使用Django REST Framework构建RESTful API：

**前端用户侧**：用户可通过前台应用进行注册、登录、个人信息管理、地址管理等操作。

**后端管理侧**：管理员通过后台管理系统进行用户管理、权限控制、日志记录等操作。

### 3.1.2 模块结构设计

该模块包含以下核心组件：

- **模型类 (Models)**：User - 用户数据模型
- **序列化器类 (Serializers)**：UserSerializer - 用户数据序列化
- **认证类 (Authentication)**：TokenAuthentication、AdminTokenAuthentication - 用户身份认证
- **权限类 (Permission)**：权限验证类 - 权限检查
- **视图类 (Views)**：
  - 前台 (index)：用户注册、登录、个人信息、密码修改
  - 后台 (admin)：用户列表、创建、更新、删除、权限管理

### 3.1.3 数据模型设计

**表3-1 User模型**

| 字段名 | 数据类型 | 长度 | 约束 | 说明 |
|-------|--------|------|------|------|
| id | BigAutoField | - | PRIMARY KEY | 用户主键，自增长 |
| username | CharField | 50 | NOT NULL UNIQUE | 用户名 / 登录名 |

---

## 第4章 数据库设计

数据库是系统开发的重要环节[14]。从需求分析阶段的用例分析中可以得到用户、图书、借阅、评论、社区等若干核心实体。下面给出对应实体属性说明与表结构设计，便于后续数据库实现和维护。

### 4.1 设计原则
- 统一命名：所有业务表以 `b_` 为前缀（Business），采用蛇形命名法。
- 主键与时间：所有主键为 `BIGINT` 自增（BigAutoField），创建时间字段统一命名为 `create_time`，写入时使用数据库当前时间。
- 状态字段：使用数字枚举（0/1）表示常见状态（0=正常，1=禁用/下线等）。
- 外键约束：使用明确的外键关系并建立索引，便于查询优化与数据完整性。

---

### 4.2 实体/数据表说明

下面列出了系统核心表的字段与说明，依据 `book_1.sql` 中实际表结构整理并补充业务含义。

#### 4.2.1 b_book（图书）

描述：存储图书基本元数据、库存与统计信息。

主要字段：
- `id` BIGINT PK：图书ID
- `title` VARCHAR(255)：书名
- `cover` VARCHAR(100)：封面路径或URL（支持豆瓣图片代理）
- `author` VARCHAR(50)：作者
- `translator` VARCHAR(50)：译者
- `description` LONGTEXT：图书简介
- `press` VARCHAR(50)：出版社
- `page_count` INT：页数
- `price` VARCHAR(50)：定价（字符串保留单位与格式）
- `isbn` VARCHAR(50)：ISBN
- `pub_date` DATE：出版日期
- `online_time` DATETIME：上架时间
- `status` CHAR(1)：状态（0=在线，1=下线）
- `repertory` INT：库存数
- `score` VARCHAR(11)：评分（字符串以兼容特殊格式）
- `layout` VARCHAR(10)：开本
- `pv` INT：浏览量
- `classification_id` BIGINT FK -> b_classification.id：分类外键
- `original_title` VARCHAR(255)：原书名
- `create_time` DATETIME：创建时间
- `recommend_count` INT：推荐数
- `wish_count` INT：愿望数
- `collect_count` INT：收藏数

索引与约束：`classification_id` 建索引并设外键约束，便于按分类查询。

业务说明：
- 图片代理：当 `cover` 为 doubanio.com 域名时，后端序列化器会将其改写为内置图片代理接口（/myapp/index/image/proxy?url=...）。
- 统计字段（pv、recommend_count、wish_count、collect_count）由相应业务操作更新，必要场景可考虑异步或缓存层聚合以缓解并发写入。

#### 4.2.2 b_classification（分类）

描述：支持多级分类（通过 `pid` 指向父分类实现层次结构）。

主要字段：
- `id` BIGINT PK
- `title` VARCHAR(255)
- `pid` BIGINT（父分类ID，顶级为0或NULL）
- `create_time` DATETIME

业务说明：用于图书浏览、筛选、后台管理。

#### 4.2.3 b_tag（标签）

描述：标签为图书提供多维度标记，系统通过中间表（ORM ManyToMany）与 `b_book` 建立多对多关系。

主要字段：`id`, `name`, `create_time`。

#### 4.2.4 b_user（用户）

描述：存储用户账户与基本资料，支持前台 token 与后台 admin_token 双令牌机制。

主要字段：
- `id` BIGINT PK
- `username` VARCHAR(50) UNIQUE
- `password` VARCHAR(128)（MD5 加密存储）
- `nickname` VARCHAR(100)
- `avatar` VARCHAR(100)
- `description` VARCHAR(300)
- `mobile` VARCHAR(30)
- `email` VARCHAR(100)
- `score` INT
- `push` INT（推送设置）
- `role` VARCHAR(1)（0=管理员，1=普通用户，2=演示用户）
- `status` VARCHAR(1)（0=正常，1=冻结）
- `token` VARCHAR(255)：前台认证令牌
- `admin_token` VARCHAR(255)：后台认证令牌
- `create_time` DATETIME

安全说明：
- 密码存储使用 MD5（当前实现），建议生产环境迁移至更安全的哈希方案（bcrypt/argon2）并加入 salt。
- 前端通过 `token` 或 `adminToken` HTTP 头传递认证凭证，后端使用 `TokenAuthentication` 与 `AdminTokenAuthentication` 解析并校验角色权限。

#### 4.2.5 b_address（地址）

描述：用户收货地址表，支持多个地址与默认标识。

主要字段：`id`, `user_id` FK -> b_user.id, `name`, `mobile`, `desc`, `default` BOOLEAN, `create_time`。

业务逻辑：当新地址设置为默认时，后台需将该用户其他地址的 `default` 字段置为 false。

#### 4.2.6 b_borrow（借阅）

描述：记录用户借阅图书的事务信息。

主要字段：
- `id` BIGINT PK
- `user_id` BIGINT FK -> b_user.id
- `book_id` BIGINT FK -> b_book.id
- `borrow_time` DATETIME
- `expect_time` DATETIME
- `return_time` DATETIME NULLABLE
- `status` VARCHAR(1)（1=借阅中，2=已归还）
- `delayed` TINYINT(1)（是否延期）
- `create_time` DATETIME

业务说明：创建借阅事务时需校验图书库存 (`b_book.repertory`) 并扣减；还书时恢复库存并记录 `return_time`。

#### 4.2.7 b_comment（评论）

描述：用户对图书的评论与评分记录。

主要字段：`id`, `content`, `user_id` FK, `book_id` FK, `comment_time`, `like_count`。

约束：限制每个用户对同一本图书只能有一条评论（业务层校验）。

#### 4.2.8 b_community_post（社区帖子） 与 b_community_comment（社区评论）

描述：用于用户发表帖子、参与讨论及评论回复。

主要字段（帖子）：`id`, `title`, `content`, `user_id`, `pv`, `like_count`, `create_time`。
主要字段（社区评论）：`id`, `post_id`, `user_id`, `content`, `create_time`, `like_count`。

点赞设计：帖子与用户之间采用 ManyToMany（liked_users）记录点赞关系以防止重复点赞。

#### 4.2.9 b_reading_event（阅读活动/活动）

描述：平台组织的线上/线下活动记录，用于增强社群粘性。

主要字段：`id`, `title`, `content`, `create_time`, `start_time`, `end_time` 等。

#### 4.2.10 展示与运营表：b_banner、b_ad、b_notice

描述：
- `b_banner`：顶部/首页横幅，字段包括 `image`, `book_id`, `create_time`。
- `b_ad`：广告位，字段包括 `image`, `link`, `create_time`。
- `b_notice`：平台公告，字段包括 `title`, `content`, `create_time`。

#### 4.2.11 审计日志：b_login_log、b_op_log、b_error_log

描述：系统运维与审计使用的日志表。

主要用途：
- `b_login_log`：记录登录事件（username、ip、ua、log_time）
- `b_op_log`：记录操作日志（request_ip、request_url、method、access_time、params/response 摘要）
- `b_error_log`：记录异常信息（ip、url、method、content、log_time）

---

### 4.3 ER 关系概述（文本说明）

- `b_user` 与 `b_address`：一对多（用户可有多个地址）
- `b_book` 与 `b_classification`：多对一（图书属于一个分类）
- `b_book` 与 `b_tag`：多对多（图书可以有多个标签）
- `b_user` 与 `b_book`（wish/collect）：多对多（通过 ORM ManyToMany 实现）
- `b_user` 与 `b_borrow`：一对多（用户可有多条借阅记录）
- `b_book` 与 `b_borrow`：一对多（一本书会有多次借阅记录）
- `b_user` 与 `b_comment`：一对多，`b_book` 与 `b_comment`：一对多
- `b_community_post` 与 `b_community_comment`：一对多

若需要图形 ER 图，可基于上述关系用工具（如 MySQL Workbench、draw.io）绘制实体关系图并嵌入到文档中。

---

### 4.4 索引与性能优化建议

- 常用查询字段建议建立索引：`b_book.classification_id`, `b_book.title`（全文/前缀索引或使用搜索引擎）、`b_user.username`（唯一索引）、`b_borrow.user_id`, `b_borrow.book_id`。
- 统计字段（pv、wish_count、collect_count、recommend_count）高并发写入时建议采用：
  - 写入合并（短期内计数写入 Redis，再定期落盘合并）
  - 或使用异步消息队列（RabbitMQ/Redis Streams）在消费端聚合后更新数据库
- 大字段（`description`, `content`）可考虑使用全文检索（MySQL InnoDB FULLTEXT、ElasticSearch）以提升检索性能。

---

### 4.5 迁移与兼容性说明

- 当前 `book_1.sql` 已包含完整表定义与示例数据，生产部署时请根据 MySQL 或目标数据库的字符集与排序规则调整 `CHARSET` 与 `COLLATE`（建议使用 `utf8mb4`）。
- 若需将密码哈希策略升级（如 bcrypt/argon2），请编写迁移脚本：在用户首次登录或通过后台重置密码流程时触发新哈希存储，并保留旧哈希字段用于兼容验证直到全部用户迁移完毕。

---

### 4.6 小结

本章基于代码与 `book_1.sql` 数据库结构，整理并规范化了系统的数据库设计说明。表结构已覆盖平台的核心业务（用户、图书、借阅、评论、社区、运营与日志），并提供了索引与性能优化建议，便于进入实现与部署阶段。

如需我将本章节转换为 ER 图、生成建表 SQL（DDL）或输出 OpenAPI/Swagger 与数据模型映射（Django ORM model -> SQL）脚本，我可以继续为你生成相应产物。
| password | CharField | 50 | NOT NULL | MD5加密密码 |
| role | CharField | 2 | - | 用户角色（0-管理员，1-普通用户，2-演示账户） |
| status | CharField | 1 | DEFAULT='0' | 账户状态（0-正常，1-封号） |
| nickname | CharField | 20 | NULL | 用户昵称 |
| avatar | FileField | - | NULL | 用户头像，上传路径avatar/ |
| mobile | CharField | 13 | NULL | 手机号码 |
| email | CharField | 50 | NULL | 邮箱（可备用） |
| gender | CharField | 1 | NULL | 性别（M-男，F-女） |
| description | TextField | 200 | NULL | 个人简介 |
| create_time | DateTimeField | - | AUTO_ADD | 创建时间 |
| score | IntegerField | - | DEFAULT=0 | 用户积分 |
| push_email | CharField | 40 | NULL | 推送邮箱 |
| push_switch | BooleanField | - | DEFAULT=False | 推送开关 |
| token | CharField | 32 | NULL | 前台用户token |
| admin_token | CharField | 32 | NULL | 后台管理员token |

### 3.1.4 前台用户API设计

**表3-2 用户登录API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/user/login |
| **请求参数** | username (邮箱)、password (密码) |
| **认证要求** | 无 |
| **响应示例** | {"code": 0, "msg": "登录成功", "data": {...user_data}} |
| **业务逻辑** | 验证用户名密码 → MD5加密比对 → 生成token → 记录登录日志 |
| **错误处理** | 用户不存在、密码错误、账户被封号 |

**表3-3 用户注册API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/user/register |
| **请求参数** | username (邮箱)、password (密码)、repassword (确认密码) |
| **认证要求** | 无 |
| **响应示例** | {"code": 0, "msg": "注册成功", "data": {...user_data}} |
| **业务逻辑** | 检查参数有效性 → 检查邮箱唯一性 → MD5加密密码 → 创建用户 |
| **错误处理** | 参数缺失、邮箱已存在、密码不一致 |

**表3-4 查看用户信息API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/user/info |
| **请求参数** | 无（从token中获取当前用户） |
| **认证要求** | TokenAuthentication (token) |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": {...user_data}} |
| **业务逻辑** | 验证token有效性 → 获取当前用户信息 → 返回序列化数据 |
| **错误处理** | token无效、用户不存在 |

**表3-5 修改用户信息API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/user/update |
| **请求参数** | nickname、avatar (文件)、gender、description |
| **认证要求** | TokenAuthentication (token) |
| **响应示例** | {"code": 0, "msg": "更新成功", "data": {...updated_user}} |
| **业务逻辑** | 验证token → 处理文件上传 → 更新用户信息 → 返回更新后的用户数据 |
| **错误处理** | token无效、文件格式不支持、参数验证失败 |

**表3-6 修改密码API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/user/updatePwd |
| **请求参数** | old_password (旧密码)、new_password (新密码) |
| **认证要求** | TokenAuthentication (token) |
| **响应示例** | {"code": 0, "msg": "密码修改成功"} |
| **业务逻辑** | 验证token → 验证旧密码正确性 → MD5加密新密码 → 更新密码 |
| **错误处理** | token无效、旧密码错误、新密码格式不符 |

### 3.1.5 后台用户管理API设计

**表3-7 管理员登录API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/adminLogin |
| **请求参数** | username (邮箱)、password (密码) |
| **认证要求** | 无 |
| **响应示例** | {"code": 0, "msg": "登录成功", "data": {...admin_data}} |
| **业务逻辑** | 验证用户名密码 → 检查role为0（管理员） → 生成admin_token → 记录日志 |
| **错误处理** | 用户不存在、密码错误、账户非管理员 |

**表3-8 用户列表查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/user/list |
| **请求参数** | keyword (搜索关键词) |
| **认证要求** | AdminTokenAuthentication (adminToken) |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...users]} |
| **业务逻辑** | 验证adminToken → 按keyword模糊搜索用户 → 按创建时间降序排列 |
| **错误处理** | token无效、权限不足 |

**表3-9 创建用户API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/user/create |
| **请求参数** | username、password、nickname、email、role |
| **认证要求** | AdminTokenAuthentication (adminToken) |
| **响应示例** | {"code": 0, "msg": "创建成功", "data": {...new_user}} |
| **业务逻辑** | 验证权限 → 检查邮箱唯一性 → MD5加密 → 保存用户 |
| **错误处理** | token无效、邮箱重复、演示账户限制操作 |

**表3-10 更新用户信息API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/user/update |
| **请求参数** | id、nickname、email、role、status |
| **认证要求** | AdminTokenAuthentication (adminToken) |
| **响应示例** | {"code": 0, "msg": "更新成功", "data": {...updated_user}} |
| **业务逻辑** | 验证权限 → 获取用户 → 更新字段 → 保存 |
| **错误处理** | 用户不存在、权限不足 |

**表3-11 删除用户API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/user/delete |
| **请求参数** | id |
| **认证要求** | AdminTokenAuthentication (adminToken) |
| **响应示例** | {"code": 0, "msg": "删除成功"} |
| **业务逻辑** | 验证权限 → 检查用户存在性 → 删除用户记录 → 级联删除相关数据 |
| **错误处理** | 用户不存在、演示账户限制、权限不足 |

### 3.1.6 认证与权限设计

**表3-12 TokenAuthentication 认证类**

| 属性 | 描述 |
|-----|------|
| **类名** | TokenAuthentication |
| **包名** | myapp.auth.authentication |
| **描述** | 前台用户token认证类，用于前台API的身份验证 |
| **继承** | BaseAuthentication |
| **主要方法** | authenticate(request) |
| **验证逻辑** | 1. 从请求头获取HTTP_TOKEN<br>2. 查询token对应的用户<br>3. token无效则抛出异常AUTH_FAIL_FRONT<br>4. 返回(user, token)元组 |
| **适用范围** | 前台所有受保护的API |

**表3-13 AdminTokenAuthentication 认证类**

| 属性 | 描述 |
|-----|------|
| **类名** | AdminTokenAuthentication |
| **包名** | myapp.auth.authentication |
| **描述** | 后台管理员token认证类，用于后台管理API的身份验证 |
| **继承** | BaseAuthentication |
| **主要方法** | authenticate(request) |
| **验证逻辑** | 1. 从请求头获取HTTP_ADMINTOKEN<br>2. 查询adminToken对应的用户<br>3. 检查用户role为0或3（管理员）<br>4. 无效则抛出异常AUTH_FAIL_END<br>5. 返回(user, admin_token)元组 |
| **适用范围** | 后台所有受保护的API |

---

## 3.2 图书信息管理模块设计

### 3.2.1 模块功能概述

图书信息管理模块实现平台图书的增删改查、分类标签管理、图书展示等功能。系统管理员可维护图书基本信息、设置上架/下架状态、管理图书分类和标签。普通用户可浏览图书列表、查看图书详情、添加到愿望单、收藏等操作。

该模块包含实体类Book、Classification、Tag，接口类BookService、ClassificationService、TagService，以及多层视图处理前后台不同的业务需求。

### 3.2.2 数据模型设计

**表3-14 Book模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键，自增长 |
| title | CharField | 255 | 图书标题 |
| original_title | CharField | 255 | 原始标题（用于外文书） |
| classification | ForeignKey | - | 关联分类 |
| tag | ManyToManyField | - | 关联标签（多个） |
| cover | ImageField | - | 图书封面，upload_to='cover/' |
| author | CharField | 50 | 作者 |
| translator | CharField | 50 | 译者 |
| description | TextField | 1000 | 图书简介 |
| press | CharField | 50 | 出版社 |
| page_count | IntegerField | - | 页数 |
| price | CharField | 50 | 价格 |
| isbn | CharField | 50 | ISBN编号 |
| pub_date | DateField | - | 出版日期 |
| online_time | DateTimeField | - | 上架时间 |
| status | CharField | 1 | 状态（0-上架，1-下架） |
| repertory | IntegerField | - | 库存数量 |
| score | CharField | 10 | 评分 |
| layout | CharField | 10 | 装帧类型 |
| create_time | DateTimeField | - | 创建时间 |
| pv | IntegerField | - | 浏览量 |
| recommend_count | IntegerField | - | 推荐次数 |
| wish | ManyToManyField | - | 愿望清单用户 |
| wish_count | IntegerField | - | 愿望清单数量 |
| collect | ManyToManyField | - | 收藏用户 |
| collect_count | IntegerField | - | 收藏数量 |

**表3-15 Classification模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| pid | IntegerField | - | 父分类ID（支持多级分类） |
| title | CharField | 100 | 分类名称 |
| create_time | DateTimeField | - | 创建时间 |

**表3-16 Tag模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 标签名称 |
| create_time | DateTimeField | - | 创建时间 |

### 3.2.3 前台图书展示API设计

**表3-17 图书列表查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/book/list |
| **请求参数** | keyword (搜索)、classification_id (分类)、tag_id (标签)、page (分页)、limit (每页条数) |
| **认证要求** | TokenAuthentication (可选) |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...books]} |
| **业务逻辑** | 获取所有上架图书 → 按分类/标签/关键词筛选 → 按推荐度/浏览量排序 → 分页返回 |
| **返回数据** | ListBookSerializer (不包含详细description) |

**表3-18 图书详情查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/book/detail |
| **请求参数** | book_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": {...book_detail}} |
| **业务逻辑** | 获取指定图书 → 增加浏览量(pv) → 获取相关评论 → 返回详细信息 |
| **返回数据** | DetailBookSerializer |

**表3-19 添加愿望单API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/book/addWishUser |
| **请求参数** | book_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "添加成功"} |
| **业务逻辑** | 验证token → 获取用户 → 检查是否已加入 → 添加到ManyToMany → 增加wish_count |
| **错误处理** | 重复添加 |

**表3-20 移除愿望单API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/book/removeWishUser |
| **请求参数** | book_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "移除成功"} |
| **业务逻辑** | 验证token → 移除用户 → 减少wish_count |

**表3-21 获取愿望单列表API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/book/getWishBookList |
| **请求参数** | page、limit |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...wish_books]} |
| **业务逻辑** | 获取当前用户的wish关系 → 分页返回相关图书 |

**表3-22 添加收藏API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/book/addCollectUser |
| **请求参数** | book_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "收藏成功"} |
| **业务逻辑** | 验证token → 添加到collect → 增加collect_count |

**表3-23 获取收藏列表API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/book/getCollectBookList |
| **请求参数** | page、limit |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...collected_books]} |
| **业务逻辑** | 获取当前用户的collect关系 → 分页返回相关图书 |

### 3.2.4 后台图书管理API设计

**表3-24 图书列表管理API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/book/list |
| **请求参数** | keyword、status、classification_id、page、limit |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...books]} |
| **业务逻辑** | 查询所有图书 → 按条件筛选 → 返回完整信息 |

**表3-25 创建图书API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/book/create |
| **请求参数** | title、author、press、description、cover (文件)、classification_id等 |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "创建成功", "data": {...new_book}} |
| **业务逻辑** | 验证权限 → 处理文件上传 → 创建图书记录 → 关联分类标签 |

**表3-26 更新图书API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/book/update |
| **请求参数** | id、title、status、repertory等 |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "更新成功", "data": {...updated_book}} |
| **业务逻辑** | 验证权限 → 获取图书 → 更新字段 → 保存 |

**表3-27 删除图书API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/book/delete |
| **请求参数** | id |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "删除成功"} |
| **业务逻辑** | 验证权限 → 删除图书 → 级联删除关联的评论、借阅记录 |

### 3.2.5 分类标签管理API设计

**表3-28 分类列表查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/classification/list (前台) / /myapp/admin/classification/list (后台) |
| **请求参数** | 无 |
| **认证要求** | 无 (前台) / AdminTokenAuthentication (后台) |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...classifications]} |
| **业务逻辑** | 获取所有分类 → 按树形结构组织 |

**表3-29 创建分类API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/admin/classification/create |
| **请求参数** | title、pid (父分类ID，可选) |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "创建成功", "data": {...classification}} |
| **业务逻辑** | 验证权限 → 检查分类名唯一性 → 创建分类 |

---

## 3.3 借阅管理模块设计

### 3.3.1 模块功能概述

借阅管理模块实现用户借阅图书、还书、延期等功能。用户可发起借阅申请、查看借阅历史、归还图书、申请延期。管理员可管理所有借阅记录、处理逾期情况、生成相关报表。

### 3.3.2 数据模型设计

**表3-30 Borrow模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| user | ForeignKey | - | 借阅用户 |
| book | ForeignKey | - | 被借图书 |
| status | CharField | 2 | 状态（1-借出，2-已还） |
| borrow_time | DateTimeField | - | 借出时间 |
| expect_time | DateTimeField | - | 应还时间 |
| return_time | DateTimeField | - | 实际还书时间 |
| delayed | BooleanField | - | 是否已延期 |

**表3-31 Address模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| user | ForeignKey | - | 所属用户 |
| name | CharField | 100 | 收货人名称 |
| mobile | CharField | 30 | 收货人电话 |
| desc | CharField | 300 | 详细地址 |
| default | BooleanField | - | 是否默认地址 |
| create_time | DateTimeField | - | 创建时间 |

### 3.3.3 借阅相关API设计

**表3-32 创建借阅API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/borrow/create |
| **请求参数** | book_id、address_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "借阅成功", "data": {...borrow}} |
| **业务逻辑** | 验证token → 检查地址 → 检查图书库存 → 创建借阅记录 → 减少库存 |
| **错误处理** | 库存不足、地址不存在 |

**表3-33 借阅列表查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/borrow/list |
| **请求参数** | status、page、limit |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...borrows]} |
| **业务逻辑** | 获取当前用户的借阅记录 → 按status筛选 → 分页返回 |

**表3-34 还书API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/borrow/return_book |
| **请求参数** | borrow_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "还书成功"} |
| **业务逻辑** | 验证token → 检查借阅记录 → 标记为已还 → 增加库存 → 记录还书时间 |

**表3-35 延期API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/borrow/delay |
| **请求参数** | borrow_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "延期成功"} |
| **业务逻辑** | 验证token → 检查延期次数 → 检查是否逾期 → 延长应还时间 → 标记delayed=True |
| **错误处理** | 超过延期次数、已逾期 |

### 3.3.4 地址管理API设计

**表3-36 地址列表查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/address/list |
| **请求参数** | 无 |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...addresses]} |
| **业务逻辑** | 获取当前用户的所有地址 |

**表3-37 创建地址API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/address/create |
| **请求参数** | name、mobile、desc、default |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "创建成功", "data": {...address}} |
| **业务逻辑** | 验证token → 创建地址 → 若default=true，则清除其他默认标记 |

---

## 3.4 评论与内容管理模块设计

### 3.4.1 模块功能概述

评论与内容管理模块实现用户发表图书评论、管理员审核删除等功能。用户可对图书发表评论和评分，管理员可查看、删除不当评论。

### 3.4.2 数据模型设计

**表3-38 Comment模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| content | CharField | 200 | 评论内容 |
| user | ForeignKey | - | 评论用户 |
| book | ForeignKey | - | 被评图书 |
| comment_time | DateTimeField | - | 评论时间 |
| like_count | IntegerField | - | 点赞数 |

### 3.4.3 评论API设计

**表3-39 图书评论列表API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/comment/list |
| **请求参数** | book_id、page、limit |
| **认证要求** | 无 |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...comments]} |
| **业务逻辑** | 获取指定图书的所有评论 → 按时间排序 → 分页返回 |

**表3-40 我的评论列表API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/comment/listMyComments |
| **请求参数** | page、limit |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...my_comments]} |
| **业务逻辑** | 获取当前用户的所有评论 → 分页返回 |

**表3-41 发表评论API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/comment/create |
| **请求参数** | book_id、content |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "发表成功", "data": {...comment}} |
| **业务逻辑** | 验证token → 检查是否已评论此书 → 创建评论记录 |
| **错误处理** | 重复评论 |

**表3-42 删除评论API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/comment/delete |
| **请求参数** | comment_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "删除成功"} |
| **业务逻辑** | 验证token → 检查权限（自己的评论或管理员） → 删除评论 |

---

## 3.5 社区互动模块设计

### 3.5.1 模块功能概述

社区互动模块实现用户发表帖子、评论、参与活动、点赞等功能。用户可发起讨论、交流阅读体验、参与平台活动。

### 3.5.2 数据模型设计

**表3-43 CommunityPost模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 帖子标题 |
| content | TextField | 2000 | 帖子内容 |
| user | ForeignKey | - | 发布用户 |
| create_time | DateTimeField | - | 创建时间 |
| views | IntegerField | - | 浏览数 |
| like_count | IntegerField | - | 点赞数 |
| liked_users | ManyToManyField | - | 点赞用户 |

**表3-44 ReadingEvent模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 活动标题 |
| description | TextField | 2000 | 活动描述 |
| cover | ImageField | - | 活动封面 |
| start_time | DateTimeField | - | 开始时间 |
| end_time | DateTimeField | - | 结束时间 |
| create_time | DateTimeField | - | 创建时间 |
| status | CharField | 1 | 状态（0-未开始，1-进行中，2-已结束） |

**表3-45 CommunityComment模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| content | CharField | 500 | 评论内容 |
| user | ForeignKey | - | 评论用户 |
| post | ForeignKey | - | 关联帖子 |
| event | ForeignKey | - | 关联活动 |
| create_time | DateTimeField | - | 创建时间 |
| like_count | IntegerField | - | 点赞数 |

### 3.5.3 社区API设计

**表3-46 帖子列表API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/community/post/list |
| **请求参数** | page、limit、sort (最新/热门) |
| **认证要求** | 无 |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...posts]} |
| **业务逻辑** | 获取所有已发布帖子 → 按条件排序 → 分页返回 |

**表3-47 发表帖子API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/community/post/create |
| **请求参数** | title、content |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "发表成功", "data": {...post}} |
| **业务逻辑** | 验证token → 创建帖子记录 |

**表3-48 点赞帖子API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/community/post/like |
| **请求参数** | post_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "点赞成功"} |
| **业务逻辑** | 验证token → 检查是否已点赞 → 添加到liked_users → 增加like_count |

**表3-49 删除帖子API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/community/post/delete |
| **请求参数** | post_id |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "删除成功"} |
| **业务逻辑** | 验证token → 检查权限 → 删除帖子及相关评论 |

**表3-50 帖子评论API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | POST /myapp/index/community/comment/create |
| **请求参数** | post_id、content |
| **认证要求** | TokenAuthentication |
| **响应示例** | {"code": 0, "msg": "评论成功", "data": {...comment}} |
| **业务逻辑** | 验证token → 创建评论 |

---

## 3.6 系统日志管理模块设计

### 3.6.1 模块功能概述

系统日志管理模块记录用户登录日志、操作日志、错误日志等，供管理员查看和分析系统运行情况。

### 3.6.2 数据模型设计

**表3-51 LoginLog模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| username | CharField | 50 | 登录用户名 |
| ip | CharField | 100 | 登录IP地址 |
| ua | CharField | 200 | User-Agent信息 |
| log_time | DateTimeField | - | 登录时间 |

**表3-52 OpLog模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| re_ip | CharField | 100 | 请求IP |
| re_time | DateTimeField | - | 请求时间 |
| re_url | CharField | 200 | 请求URL |
| re_method | CharField | 10 | 请求方法(GET/POST) |
| re_content | CharField | 200 | 请求内容摘要 |
| access_time | CharField | 10 | 响应时间(ms) |

**表3-53 ErrorLog模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| ip | CharField | 100 | 请求IP |
| url | CharField | 200 | 错误URL |
| method | CharField | 10 | 请求方法 |
| content | CharField | 200 | 错误信息 |
| log_time | DateTimeField | - | 发生时间 |

### 3.6.3 日志查询API设计

**表3-54 登录日志查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/loginLog/list |
| **请求参数** | username、start_date、end_date、page、limit |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...logs]} |
| **业务逻辑** | 验证权限 → 按条件筛选登录日志 → 分页返回 |

**表3-55 操作日志查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/opLog/list |
| **请求参数** | keyword、method、page、limit |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...logs]} |
| **业务逻辑** | 验证权限 → 按URL/方法筛选 → 分页返回 |

**表3-56 错误日志查询API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/errorLog/list |
| **请求参数** | url、keyword、page、limit |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": [...logs]} |
| **业务逻辑** | 验证权限 → 按URL/错误类型筛选 → 分页返回 |

---

## 3.7 系统管理模块设计

### 3.7.1 模块功能概述

系统管理模块提供管理员对广告、横幅、通知、活动等平台资源的管理功能。

### 3.7.2 数据模型设计

**表3-57 Banner模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| image | ImageField | - | 横幅图片 |
| book | ForeignKey | - | 关联图书 |
| create_time | DateTimeField | - | 创建时间 |

**表3-58 Ad模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| image | ImageField | - | 广告图片 |
| link | CharField | 500 | 链接地址 |
| create_time | DateTimeField | - | 创建时间 |

**表3-59 Notice模型**

| 字段名 | 数据类型 | 长度 | 说明 |
|-------|--------|------|------|
| id | BigAutoField | - | 主键 |
| title | CharField | 100 | 通知标题 |
| content | CharField | 1000 | 通知内容 |
| create_time | DateTimeField | - | 创建时间 |

### 3.7.3 系统资源管理API设计

**表3-60 广告管理API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/ad/list<br>POST /myapp/admin/ad/create<br>POST /myapp/admin/ad/update<br>POST /myapp/admin/ad/delete |
| **请求参数** | image (文件)、link、id |
| **认证要求** | AdminTokenAuthentication |
| **业务逻辑** | 列表：查询所有广告<br>创建：上传图片，保存链接<br>更新：修改图片和链接<br>删除：删除广告记录 |

**表3-61 横幅管理API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/banner/list<br>POST /myapp/admin/banner/create<br>POST /myapp/admin/banner/update<br>POST /myapp/admin/banner/delete |
| **请求参数** | image (文件)、book_id、id |
| **认证要求** | AdminTokenAuthentication |
| **业务逻辑** | 列表：查询所有横幅<br>创建：上传图片，关联图书<br>更新：修改图片和关联<br>删除：删除横幅记录 |

**表3-62 通知管理API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/notice/list_api (前台)<br>POST /myapp/admin/notice/list (后台)<br>POST /myapp/admin/notice/create<br>POST /myapp/admin/notice/update<br>POST /myapp/admin/notice/delete |
| **请求参数** | title、content、id |
| **认证要求** | 无 (前台列表) / AdminTokenAuthentication (后台) |
| **业务逻辑** | 列表：查询通知<br>创建：创建新通知<br>更新：修改通知内容<br>删除：删除通知 |

**表3-63 活动管理API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/index/community/event/list<br>POST /myapp/admin/event/list<br>POST /myapp/admin/event/create<br>POST /myapp/admin/event/update<br>POST /myapp/admin/event/delete |
| **请求参数** | title、description、cover (文件)、start_time、end_time、status |
| **认证要求** | 无 (前台列表) / AdminTokenAuthentication (后台) |
| **业务逻辑** | 列表：查询活动<br>创建：创建活动，上传封面<br>更新：修改活动信息<br>删除：删除活动 |

### 3.7.4 系统概览API设计

**表3-64 数据统计API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/overview/count |
| **请求参数** | 无 |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": {<br>"user_count": 100,<br>"book_count": 500,<br>"borrow_count": 50,<br>"comment_count": 200<br>}} |
| **业务逻辑** | 统计用户总数、图书总数、借阅总数、评论总数等关键指标 |

**表3-65 系统信息API**

| 属性 | 描述 |
|-----|------|
| **请求路径** | GET /myapp/admin/overview/sysInfo |
| **请求参数** | 无 |
| **认证要求** | AdminTokenAuthentication |
| **响应示例** | {"code": 0, "msg": "查询成功", "data": {<br>"python_version": "3.x.x",<br>"django_version": "4.x.x",<br>"cpu_percent": 45,<br>"memory_usage": 60<br>}} |
| **业务逻辑** | 获取服务器运行状态、Python/Django版本、系统资源使用情况 |

---

## 3.8 前端架构设计

### 3.8.1 框架技术栈

前端采用**Vue 2.x + Ant Design Vue + Vue Router + Vuex**的技术栈：

- **Vue 2.x**：渐进式JavaScript框架，提供响应式数据绑定和组件化开发
- **Ant Design Vue**：企业级UI组件库，提供丰富的表单、表格、弹框等组件
- **Vue Router**：前端路由管理，实现单页应用导航
- **Vuex**：状态管理库，集中管理用户认证、应用全局状态

### 3.8.2 项目目录结构

```
client/
├── src/
│   ├── api/                 # API层
│   │   ├── admin/          # 后台管理API客户端
│   │   └── index/          # 前台用户API客户端
│   ├── views/              # 页面组件
│   │   ├── admin/          # 后台管理页面
│   │   └── index/          # 前台用户页面
│   ├── router/             # 路由配置
│   │   └── index.js        # 路由总配置
│   ├── store/              # Vuex状态管理
│   │   └── modules/
│   │       └── user.js     # 用户状态模块
│   ├── components/         # 全局共享组件
│   ├── utils/              # 工具函数
│   │   └── request.js      # axios拦截器
│   └── main.js             # 应用入口
└── package.json
```

### 3.8.3 API客户端设计模式

每个资源的API客户端遵循统一的设计模式：

**表3-66 API客户端设计模式示例**

```javascript
// client/src/api/index/book.js
import axios from '@/utils/request.js'

const api = {
  listApi: '/myapp/index/book/list',
  detailApi: '/myapp/index/book/detail',
  addWishUserApi: '/myapp/index/book/addWishUser',
  // ...
}

export const listApi = function (data) {
  return axios({
    url: api.listApi,
    method: 'get',
    params: data
  })
}

export const detailApi = function (data) {
  return axios({
    url: api.detailApi,
    method: 'get',
    params: data
  })
}
// ...
```

### 3.8.4 Vuex状态管理设计

状态管理分为**前台用户状态**和**后台管理员状态**两套独立的模块：

**表3-67 用户状态管理**

| 状态字段 | 类型 | 说明 |
|--------|------|------|
| token | String | 前台用户token |
| username | String | 前台用户名 |
| userId | Number | 前台用户ID |
| adminToken | String | 后台管理员token |
| adminUserName | String | 后台管理员名 |

### 3.8.5 请求拦截器设计

**表3-68 axios拦截器功能**

| 功能 | 说明 |
|-----|------|
| **请求拦截** | 自动附加token和adminToken到请求头 |
| **响应拦截** | 处理403认证失败，触发logout并跳转登录页 |
| **错误处理** | 统一处理API错误响应 |

---

## 3.9 后端架构设计

### 3.9.1 框架技术栈

后端采用**Django 4.1.4 + Django REST Framework**的技术栈：

- **Django**：Python高级Web框架，提供ORM、中间件、URL路由等功能
- **Django REST Framework (DRF)**：构建RESTful API的强大工具，提供序列化、认证、权限等功能
- **MySQL/SQLite**：关系型数据库，支持生产环境和开发环境切换

### 3.9.2 项目目录结构

```
server/
├── bookproject/            # Django主项目配置
│   ├── settings.py        # 项目设置(数据库、CORS、中间件)
│   ├── urls.py            # 路由总入口
│   ├── wsgi.py            # WSGI入口
│   └── asgi.py            # ASGI入口
├── myapp/                 # 业务应用
│   ├── models.py          # ORM模型
│   ├── serializers.py     # DRF序列化器
│   ├── urls.py            # 路由映射
│   ├── views/             # 视图层
│   │   ├── admin/         # 后台管理视图
│   │   └── index/         # 前台用户视图
│   ├── auth/              # 认证模块
│   ├── permission/        # 权限模块
│   ├── middlewares/       # 中间件
│   ├── migrations/        # 数据库迁移
│   └── recommend_books/   # 推荐算法模块
├── manage.py              # Django管理命令
└── requirements.txt       # 项目依赖
```

### 3.9.3 URL路由约定

后端遵循统一的RESTful URL设计：

**表3-69 URL路由约定**

| 路由类型 | URL格式 | 示例 | 说明 |
|---------|--------|------|------|
| 前台列表 | /myapp/index/{resource}/list | /myapp/index/book/list | 获取资源列表 |
| 前台详情 | /myapp/index/{resource}/detail | /myapp/index/book/detail | 获取资源详情 |
| 前台创建 | /myapp/index/{resource}/create | /myapp/index/comment/create | 创建资源 |
| 前台删除 | /myapp/index/{resource}/delete | /myapp/index/comment/delete | 删除资源 |
| 后台列表 | /myapp/admin/{resource}/list | /myapp/admin/book/list | 获取资源列表 |
| 后台创建 | /myapp/admin/{resource}/create | /myapp/admin/book/create | 创建资源 |
| 后台更新 | /myapp/admin/{resource}/update | /myapp/admin/book/update | 更新资源 |
| 后台删除 | /myapp/admin/{resource}/delete | /myapp/admin/book/delete | 删除资源 |

### 3.9.4 视图函数设计模式

每个视图函数遵循统一的设计模式：

**表3-70 视图函数设计模式示例**

```python
from rest_framework.decorators import api_view, authentication_classes
from myapp.auth.authentication import TokenAuthentication
from myapp.handler import APIResponse

@api_view(['GET'])
@authentication_classes([TokenAuthentication])
def list_api(request):
    """
    业务逻辑三步曲：
    1. 权限验证 - 由@authentication_classes装饰器自动处理
    2. 业务处理 - 查询数据库、数据转换等
    3. 响应返回 - 统一使用APIResponse格式
    """
    try:
        # 业务逻辑
        data = Model.objects.all()
        serializer = Serializer(data, many=True)
        return APIResponse(code=0, msg='查询成功', data=serializer.data)
    except Exception as e:
        return APIResponse(code=1, msg='查询失败')
```

### 3.9.5 序列化器设计

DRF序列化器用于模型数据的序列化和反序列化：

**表3-71 序列化器设计示例**

```python
class BookSerializer(serializers.ModelSerializer):
    # 额外字段：从外键对象取值
    classification_title = serializers.ReadOnlyField(source='classification.title')
    
    class Meta:
        model = Book
        fields = '__all__'  # 包含所有字段
        
    def to_representation(self, instance):
        # 动态字段处理：代理豆瓣图片URL
        ret = super().to_representation(instance)
        if instance.cover and str(instance.cover).startswith('http'):
            ret['cover'] = rewrite_cover_url(str(instance.cover), ...)
        return ret
```

### 3.9.6 中间件与日志记录

系统配置了日志中间件自动记录所有API操作：

**表3-72 日志中间件功能**

| 功能 | 说明 |
|-----|------|
| **请求记录** | 记录IP、URL、HTTP方法、请求时间戳等 |
| **响应记录** | 记录响应耗时(ms) |
| **错误记录** | 捕获未处理异常并记录错误日志 |
| **性能监控** | 识别慢查询和性能瓶颈 |

---

## 3.10 数据库设计

### 3.10.1 数据库支持

系统支持两种数据库配置，通过修改settings.py切换：

```python
# 开发环境：SQLite
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# 生产环境：MySQL
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'book_sharing',
        'USER': 'root',
        'PASSWORD': 'password',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
```

### 3.10.2 表命名规范

所有业务表名均以`b_`作为前缀：

| 表名 | 描述 |
|-----|------|
| b_user | 用户表 |
| b_book | 图书表 |
| b_classification | 分类表 |
| b_tag | 标签表 |
| b_comment | 图书评论表 |
| b_borrow | 借阅记录表 |
| b_address | 用户地址表 |
| b_community_post | 社区帖子表 |
| b_community_comment | 社区评论表 |
| b_reading_event | 阅读活动表 |
| b_banner | 横幅表 |
| b_ad | 广告表 |
| b_notice | 通知表 |
| b_login_log | 登录日志表 |
| b_op_log | 操作日志表 |
| b_error_log | 错误日志表 |

---

## 小结

本章详细阐述了社区化图书共享与推荐平台的系统设计，涵盖以下核心模块：

1. **用户信息管理模块** - 用户认证、个人信息管理、权限控制
2. **图书信息管理模块** - 图书的增删改查、分类标签、收藏愿望单
3. **借阅管理模块** - 借阅流程、还书、延期、地址管理
4. **评论与内容管理模块** - 用户评论、社区互动
5. **社区互动模块** - 帖子、点赞、活动参与
6. **系统日志管理模块** - 登录日志、操作日志、错误日志
7. **系统管理模块** - 广告、横幅、通知、活动管理
8. **前端架构** - Vue 2.x技术栈、状态管理、请求拦截
9. **后端架构** - Django REST Framework、中间件、序列化器
10. **数据库设计** - MySQL/SQLite支持、表命名规范

整个系统采用**前后端分离**的架构模式，通过**RESTful API**进行通信，使用**Token认证**机制保证接口安全，利用**中间件和装饰器**实现横切关注点的处理，构建了一个完整、可扩展的社区化图书共享与推荐平台。

